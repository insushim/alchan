rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================
    // ğŸ”’ í”„ë¡œë•ì…˜ìš© ë³´ì•ˆ ê·œì¹™
    // í•™ê¸‰ ê²½ì œ êµìœ¡ ì•±ì— ë§ì¶¤ ì„¤ì •
    // ========================================================

    // í—¬í¼ í•¨ìˆ˜ë“¤
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // SuperAdminì€ ê´€ë¦¬ì ê¶Œí•œì„ ëª¨ë‘ í¬í•¨
      return isSignedIn() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
              isSuperAdmin());
    }

    function isSuperAdmin() {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
    }

    function getUserClassCode() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.classCode;
    }

    function isSameClass(classCode) {
      return isSignedIn() && getUserClassCode() == classCode;
    }

    // ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
    function isValidUserData() {
      return request.resource.data.keys().hasAll(['name', 'classCode', 'cash', 'coupons']) &&
             request.resource.data.cash >= 0 &&
             request.resource.data.coupons >= 0;
    }

    // ========================================================
    // ğŸ“ users ì»¬ë ‰ì…˜
    // ========================================================
    match /users/{userId} {
      // ì½ê¸°: ë³¸ì¸, ê°™ì€ í•™ê¸‰, ê´€ë¦¬ì, ë˜ëŠ” SuperAdmin (ì „ì²´ ëª©ë¡ ì¡°íšŒìš©)
      allow read: if isOwner(userId) || isSameClass(resource.data.classCode) || isAdmin() || isSuperAdmin();

      // ìƒì„±: ë³¸ì¸ë§Œ (íšŒì›ê°€ì…)
      allow create: if isOwner(userId) && isValidUserData();

      // ìˆ˜ì •: ë³¸ì¸, ê°™ì€ í•™ê¸‰, ë˜ëŠ” ê´€ë¦¬ì
      // - ë³¸ì¸: ì¤‘ìš” í•„ë“œ(isAdmin, isSuperAdmin, classCode) ì œì™¸ ëª¨ë“  í•„ë“œ ìˆ˜ì • ê°€ëŠ¥
      // - ê°™ì€ í•™ê¸‰: cash, updatedAt í•„ë“œë§Œ ìˆ˜ì • ê°€ëŠ¥ (ì†¡ê¸ˆ, ë²Œê¸ˆ ë“±)
      // - ê´€ë¦¬ì: ëª¨ë“  í•„ë“œ ìˆ˜ì • ê°€ëŠ¥
      allow update: if (isOwner(userId) &&
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'isSuperAdmin', 'isTeacher', 'isApproved', 'role'])) ||
                       (isSameClass(resource.data.classCode) &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['cash', 'updatedAt'])) ||
                       isAdmin();

      // ì‚­ì œ: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow delete: if isOwner(userId) || isAdmin();

      // ========================================================
      // ğŸ’° ê±°ë˜ ê¸°ë¡ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/transactions/{transactionId})
      // ========================================================
      match /transactions/{transactionId} {
        allow read: if isOwner(userId) || isAdmin();
        // ìƒì„±: ë³¸ì¸ ë˜ëŠ” ê°™ì€ í•™ê¸‰ ì‚¬ìš©ì (ì†¡ê¸ˆ ì‹œ ìƒëŒ€ë°© ê±°ë˜ ê¸°ë¡ ìƒì„± ê°€ëŠ¥)
        allow create: if isOwner(userId) ||
                         (isSignedIn() &&
                          isSameClass(get(/databases/$(database)/documents/users/$(userId)).data.classCode));
        allow update: if false; // ê±°ë˜ ê¸°ë¡ì€ ìˆ˜ì • ë¶ˆê°€
        allow delete: if isAdmin();
      }

      // ========================================================
      // ğŸ“ˆ ì£¼ì‹ í¬íŠ¸í´ë¦¬ì˜¤ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/portfolio/{stockId})
      // ========================================================
      match /portfolio/{stockId} {
        allow read: if isOwner(userId) || isSameClass(get(/databases/$(database)/documents/users/$(userId)).data.classCode) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }

      // ========================================================
      // ğŸ“¦ ì¸ë²¤í† ë¦¬ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/inventory/{itemId})
      // ========================================================
      match /inventory/{itemId} {
        // ì½ê¸°: ë³¸ì¸, ê´€ë¦¬ì, ë˜ëŠ” ê°™ì€ í•™ê¸‰ ì‚¬ìš©ì (ì•„ì´í…œ ì„ ë¬¼ ê¸°ëŠ¥ì„ ìœ„í•´)
        allow read: if isOwner(userId) || isAdmin() || (isSignedIn() && isSameClass(get(/databases/$(database)/documents/users/$(userId)).data.classCode));
        // ì“°ê¸°: ë³¸ì¸, ê´€ë¦¬ì, ë˜ëŠ” ê°™ì€ í•™ê¸‰ ì‚¬ìš©ì (ì•„ì´í…œ ì„ ë¬¼ ê¸°ëŠ¥ì„ ìœ„í•´)
        allow write: if isOwner(userId) || isAdmin() || (isSignedIn() && isSameClass(get(/databases/$(database)/documents/users/$(userId)).data.classCode));
      }

      // ========================================================
      // ğŸ¯ ì™„ë£Œëœ ê³¼ì œ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/completedTasks/{taskId})
      // ========================================================
      match /completedTasks/{taskId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }

      // ========================================================
      // ğŸ’° ê¸ˆìœµ ì •ë³´ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/financials/{document})
      // ========================================================
      match /financials/{document} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }

      // ========================================================
      // ğŸ“¦ ê°€ì… ìƒí’ˆ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/products/{productId})
      // ========================================================
      match /products/{productId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }

      // ========================================================
      // ğŸ’¸ ëŒ€ì¶œ ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/loans/{loanId})
      // ========================================================
      match /loans/{loanId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }

      // ========================================================
      // âš™ï¸ ì‚¬ìš©ì ì„¤ì • ì„œë¸Œì»¬ë ‰ì…˜ (users/{userId}/settings/{settingId})
      // íŠœí† ë¦¬ì–¼ ìƒíƒœ, í…Œë§ˆ ë“± ì‚¬ìš©ì ê°œì¸ ì„¤ì •
      // ========================================================
      match /settings/{settingId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
    }

    // ========================================================
    // ğŸ“ˆ ì£¼ì‹ í¬íŠ¸í´ë¦¬ì˜¤ (ClassStock/{classCode}/portfolio/{userId})
    // ========================================================
    match /ClassStock/{classCode}/portfolio/{userId} {
      allow read: if isSameClass(classCode) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();

      match /holdings/{holdingId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
    }

    // ========================================================
    // ğŸ‘¨â€ğŸ“ í•™ìƒ ë°ì´í„° (ClassStock/{classCode}/students/{userId})
    // ========================================================
    match /ClassStock/{classCode}/students/{userId} {
      allow read: if isSameClass(classCode) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();

      // ë¶€ë™ì‚° ì„œë¸Œì»¬ë ‰ì…˜
      match /realestates/{estateId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }

      // íŒŒí‚¹í†µì¥ ì„œë¸Œì»¬ë ‰ì…˜
      match /parkingAccounts/{accountId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
    }

    // ========================================================
    // ğŸ’¹ ì£¼ì‹ ì •ë³´ (ClassStock/{classCode}/stocks/{stockId})
    // ========================================================
    match /ClassStock/{classCode}/stocks/{stockId} {
      allow read: if isSameClass(classCode);
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ“° ë‰´ìŠ¤ (ClassStock/{classCode}/news/{newsId})
    // ========================================================
    match /ClassStock/{classCode}/news/{newsId} {
      allow read: if isSameClass(classCode);
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ¢ ì¤‘ì•™ ì£¼ì‹ ì‹œì¥ (CentralStocks)
    // ========================================================
    match /CentralStocks/{stockId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /CentralNews/{newsId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ“Š ì‹œì¥ ìƒí™© (MarketCondition)
    // ========================================================
    match /MarketCondition/{conditionId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸª ìƒì  ì•„ì´í…œ (storeItems)
    // ========================================================
    match /storeItems/{itemId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ›’ ë§ˆì¼“ ì•„ì´í…œ (marketItems)
    // ========================================================
    match /marketItems/{listingId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.sellerId);
      allow update: if isSignedIn() &&
                       (isOwner(resource.data.sellerId) ||
                        isOwner(resource.data.buyerId) ||
                        isAdmin());
      allow delete: if isOwner(resource.data.sellerId) || isAdmin();
    }

    // ========================================================
    // ğŸ“ í™œë™ ë¡œê·¸ (activity_logs)
    // ========================================================
    match /activity_logs/{logId} {
      allow read: if isSameClass(resource.data.classCode) || isAdmin();
      allow create: if isSignedIn();
      allow update: if false; // ë¡œê·¸ëŠ” ìˆ˜ì • ë¶ˆê°€
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ›ï¸ ì •ë¶€ ì„¤ì • (governmentSettings)
    // ========================================================
    match /governmentSettings/{classCode} {
      allow read: if isSameClass(classCode);
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ¦ êµ­ê³  (nationalTreasuries)
    // ========================================================
    match /nationalTreasuries/{classCode} {
      allow read: if isSameClass(classCode);
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ¦ ì€í–‰ ìƒí’ˆ ì„¤ì • (bankingSettings)
    // ========================================================
    match /bankingSettings/{classCode} {
      allow read: if isSameClass(classCode);
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ ê¸°ë¶€ ê¸°ë¡ (donations)
    // ========================================================
    match /donations/{donationId} {
      allow read: if isSameClass(resource.data.classCode) || isAdmin();
      allow create: if isSignedIn() && isOwner(request.resource.data.donorId);
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ========================================================
    // âš–ï¸ ì •ì‚° ê¸°ë¡ (settlements)
    // ========================================================
    match /settlements/{settlementId} {
      allow read: if isSameClass(resource.data.classCode) || isAdmin();
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ˜ï¸ ë¶€ë™ì‚° (realEstate)
    // ========================================================
    match /realEstate/{propertyId} {
      allow read: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isOwner(resource.data.ownerId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================
    // âš–ï¸ ì¬íŒ (trials)
    // ========================================================
    match /trials/{trialId} {
      allow read: if isSameClass(resource.data.classCode) || isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin(); // ì¬íŒ ì§„í–‰ì€ ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ¯ ê²½ë§¤ (auctions)
    // ========================================================
    match /auctions/{auctionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
                       (isSameClass(resource.data.classCode) || isAdmin());
      allow delete: if isOwner(resource.data.sellerId) || isAdmin();
    }

    match /auctions/{auctionId}/bids/{bidId} {
      allow read: if isSameClass(get(/databases/$(database)/documents/auctions/$(auctionId)).data.classCode);
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ“š í•™ìŠµ ìë£Œ (learningMaterials)
    // ========================================================
    match /learningMaterials/{materialId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸµ ìŒì•… ìš”ì²­ (musicRequests)
    // ========================================================
    match /musicRequests/{requestId} {
      allow read: if isSameClass(resource.data.classCode) || isAdmin();
      allow create: if isSignedIn();
      allow update: if isOwner(resource.data.requesterId) || isAdmin();
      allow delete: if isOwner(resource.data.requesterId) || isAdmin();
    }

    // ========================================================
    // ğŸ® ê²Œì„ (games - ì˜¤ëª©, ì¥ê¸°, ì²´ìŠ¤ ë“±)
    // ========================================================
    match /games/{gameId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() &&
                       (resource.data.player1 == request.auth.uid ||
                        resource.data.player2 == request.auth.uid ||
                        isAdmin());
      allow delete: if isAdmin();
    }

    // ========================================================
    // â™Ÿï¸ ì²´ìŠ¤ ê²Œì„ (chessGames)
    // ========================================================
    match /chessGames/{gameId} {
      allow read, create: if isSignedIn();
      allow update: if isSignedIn() &&
                       (resource.data.player1 == request.auth.uid ||
                        resource.data.player2 == request.auth.uid ||
                        resource.data.aiMode == true ||
                        isAdmin());
      allow delete: if isSignedIn() &&
                       (resource.data.player1 == request.auth.uid ||
                        resource.data.player2 == request.auth.uid ||
                        isAdmin());
    }

    // ========================================================
    // âš«ï¸ ì˜¤ëª© ê²Œì„ (omokGames)
    // ========================================================
    match /omokGames/{gameId} {
      allow read, create: if isSignedIn();
      allow update: if isSignedIn() && (request.auth.uid in resource.data.players.keys() || isAdmin());
      allow delete: if isSignedIn() && (resource.data.host == request.auth.uid || isAdmin());
    }

    // ========================================================
    // ğŸ® ê³ ëˆ„ ê²Œì„ (gonuGames)
    // ========================================================
    match /gonuGames/{gameId} {
      allow read, create: if isSignedIn();
      allow update: if isSignedIn() &&
                       (resource.data.players.B == request.auth.uid ||
                        resource.data.players.W == request.auth.uid ||
                        isAdmin());
      allow delete: if isSignedIn() &&
                       (resource.data.players.B == request.auth.uid ||
                        resource.data.players.W == request.auth.uid ||
                        isAdmin());
    }

    // ========================================================
    // ğŸ“Š í†µê³„ (system_stats)
    // ========================================================
    match /system_stats/{statId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ”´ ì—ëŸ¬ ë¡œê·¸ (errorLogs) - SuperAdmin ì „ìš©
    // ========================================================
    match /errorLogs/{logId} {
      // ì½ê¸°: SuperAdminë§Œ
      allow read: if isSuperAdmin();
      // ì“°ê¸°: ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ì (ì—ëŸ¬ ë°œìƒ ì‹œ ìë™ ê¸°ë¡) ë˜ëŠ” SuperAdmin
      allow create: if isSignedIn();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // ========================================================
    // ğŸš¨ ê²½ì°°ì„œ (policeReports)
    // ========================================================
    match /policeReports/{reportId} {
      allow read: if isSameClass(resource.data.classCode) || isAdmin();
      allow create: if isSignedIn();
      allow update: if isSameClass(resource.data.classCode) || isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ›ï¸ êµ­íšŒ (legislations)
    // ========================================================
    match /legislations/{legislationId} {
      allow read: if isSameClass(resource.data.classCode);
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /legislations/{legislationId}/votes/{voteId} {
      allow read: if isSameClass(get(/databases/$(database)/documents/legislations/$(legislationId)).data.classCode);
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ« ì£¼ì°¨ê¶Œ (parkingTickets)
    // ========================================================
    match /parkingTickets/{ticketId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isSignedIn();
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ“‹ ì¡°ì§ë„ (organizationChart)
    // ========================================================
    match /organizationChart/{classCode} {
      allow read: if isSameClass(classCode);
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ’¼ ì§ì—… (jobs)
    // ========================================================
    match /jobs/{jobId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì, classCode ì¿¼ë¦¬ í—ˆìš©
      allow read: if isSignedIn();
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ“ ê³µí†µ í• ì¼ (commonTasks)
    // ========================================================
    match /commonTasks/{taskId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì, classCode ì¿¼ë¦¬ í—ˆìš©
      allow read: if isSignedIn();
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ¯ ê³¼ì œ (tasks)
    // ========================================================
    match /tasks/{taskId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================
    // âš™ï¸ ì „ì—­ ì„¤ì • (settings)
    // ========================================================
    match /Settings/{documentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // settings (ì†Œë¬¸ì) - classCodes ë“±
    match /settings/{documentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ’° ì„¸ê¸ˆ ì„¤ì • (taxSettings)
    // ========================================================
    match /taxSettings/{classCode} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ì£¼ì‹ ê±°ë˜ ì‹œ ì„¸ìœ¨ í™•ì¸ìš©)
      allow read: if isSignedIn();
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ¯ í•™ê¸‰ ëª©í‘œ (goals)
    // ========================================================
    match /goals/{goalId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (ëª©í‘œ í™•ì¸ìš©)
      allow read: if isSignedIn();

      // ìƒì„±: ê´€ë¦¬ìë§Œ
      allow create: if isAdmin();

      // ìˆ˜ì •: ê¸°ë¶€ ê´€ë ¨ í•„ë“œë§Œ ì¼ë°˜ ì‚¬ìš©ì ìˆ˜ì • ê°€ëŠ¥, ë‚˜ë¨¸ì§€ëŠ” ê´€ë¦¬ìë§Œ
      allow update: if isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['progress', 'donations', 'currentAmount', 'updatedAt']));

      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ« Class ì»¬ë ‰ì…˜ (ëŒ€ë¬¸ì - ì‹¤ì œ í•™ê¸‰ ë°ì´í„°)
    // SuperAdminì€ ëª¨ë“  í•™ê¸‰ ì¡°íšŒ ê°€ëŠ¥
    // ========================================================
    match /Class/{classCode} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (í•™ê¸‰ ëª©ë¡ ì¡°íšŒìš©)
      allow read: if isSignedIn();
      // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” SuperAdmin
      allow write: if isAdmin() || isSuperAdmin();

      // í•™ìƒ ì„œë¸Œì»¬ë ‰ì…˜
      match /students/{studentId} {
        // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
        allow read: if isSignedIn();
        // ì“°ê¸°: ê´€ë¦¬ì ë˜ëŠ” SuperAdmin
        allow write: if isAdmin() || isSuperAdmin();
      }
    }

    // ========================================================
    // ğŸ« í•™ê¸‰ ë°ì´í„° (classes - ì†Œë¬¸ì)
    // ========================================================
    match /classes/{classCode} {
      allow read: if isSameClass(classCode) || isAdmin();
      allow write: if isAdmin();

      // ğŸ“š í•™ìŠµ ê²Œì‹œíŒ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/learningBoards/{boardId})
      match /learningBoards/{boardId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();

        // ê²Œì‹œê¸€ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/learningBoards/{boardId}/posts/{postId})
        match /posts/{postId} {
          allow read: if isSameClass(classCode) || isAdmin();
          allow create: if isSignedIn() && isSameClass(classCode);
          allow update: if isSignedIn() && isSameClass(classCode);
          allow delete: if isAdmin();
        }
      }

      // ğŸµ ìŒì•… ìš”ì²­ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/musicRequests/{requestId})
      match /musicRequests/{requestId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && isSameClass(classCode);
        allow update: if isSignedIn() && isSameClass(classCode);
        allow delete: if isOwner(resource.data.requesterId) || isAdmin();
      }

      // ë¶€ë™ì‚° ì„œë¸Œì»¬ë ‰ì…˜
      match /realEstateProperties/{propertyId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isAdmin();
      }

      // ë¶€ë™ì‚° ì„¤ì • ì„œë¸Œì»¬ë ‰ì…˜
      match /realEstateSettings/{settingsDoc} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isAdmin();
      }

      // ğŸ¯ ê²½ë§¤ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/auctions/{auctionId})
      match /auctions/{auctionId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && isSameClass(classCode);
        allow update: if isSignedIn() && isSameClass(classCode);
        allow delete: if isAdmin();

        // ì…ì°° ì„œë¸Œì»¬ë ‰ì…˜
        match /bids/{bidId} {
          allow read: if isSameClass(classCode) || isAdmin();
          allow create: if isSignedIn() && isSameClass(classCode);
          allow update: if false;
          allow delete: if isAdmin();
        }
      }

      // ğŸ›ï¸ êµ­íšŒ ë²•ì•ˆ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/nationalAssemblyLaws/{lawId})
      match /nationalAssemblyLaws/{lawId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && (isSameClass(classCode) || isAdmin());
        allow update: if isSignedIn() && (isSameClass(classCode) || isAdmin());
        allow delete: if isAdmin();
      }

      // ğŸ›ï¸ êµ­íšŒ ì„¤ì • ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/nationalAssemblySettings/{document})
      match /nationalAssemblySettings/{document} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isAdmin();
      }

      // ğŸ—³ï¸ ì‚¬ìš©ì íˆ¬í‘œ ê¸°ë¡ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/userVotes/{userId})
      match /userVotes/{userId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && (isOwner(userId) || isAdmin());
        allow update: if isSignedIn() && (isOwner(userId) || isAdmin());
        allow delete: if isAdmin();
      }

      // ğŸ¦ êµ­ê³  ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/treasury/{document})
      match /treasury/{document} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isAdmin();
      }

      // ğŸ’° êµ­ê³  ê±°ë˜ ë‚´ì—­ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/treasuryTransactions/{transactionId})
      match /treasuryTransactions/{transactionId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isAdmin();
        allow update: if false; // ê±°ë˜ ë‚´ì—­ì€ ìˆ˜ì • ë¶ˆê°€
        allow delete: if isAdmin();
      }

      // ğŸš¨ ê²½ì°°ì„œ ì‹ ê³  ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/policeReports/{reportId})
      match /policeReports/{reportId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && isSameClass(classCode);
        allow update: if isSignedIn() && isSameClass(classCode);
        allow delete: if isAdmin();
      }

      // ğŸš¨ ê²½ì°°ì„œ ì‹ ê³  ì‚¬ìœ  ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/policeReportReasons/{document})
      match /policeReportReasons/{document} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isAdmin();
      }

      // âš–ï¸ ë²•ì› ê³ ì†Œì¥ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/courtComplaints/{complaintId})
      match /courtComplaints/{complaintId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && isSameClass(classCode);
        allow update: if isSignedIn() && isSameClass(classCode);
        allow delete: if isAdmin();
      }

      // âš–ï¸ ì¬íŒë°© ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/trialRooms/{roomId})
      match /trialRooms/{roomId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && isSameClass(classCode);
        allow update: if isSignedIn() && isSameClass(classCode);
        allow delete: if isAdmin();

        // ì¬íŒë°© ë©”ì‹œì§€ ì„œë¸Œì»¬ë ‰ì…˜
        match /messages/{messageId} {
          allow read: if isSameClass(classCode) || isAdmin();
          allow create: if isSignedIn() && isSameClass(classCode);
          allow update: if false; // ë©”ì‹œì§€ëŠ” ìˆ˜ì • ë¶ˆê°€
          allow delete: if isAdmin();
        }

        // ì¬íŒë°© ì¦ê±° ìë£Œ ì„œë¸Œì»¬ë ‰ì…˜
        match /evidence/{evidenceId} {
          allow read: if isSameClass(classCode) || isAdmin();
          allow create: if isSignedIn() && isSameClass(classCode);
          allow update: if false; // ì¦ê±°ëŠ” ìˆ˜ì • ë¶ˆê°€
          allow delete: if isAdmin();
        }

        // ì¬íŒë°© íˆ¬í‘œ ì„œë¸Œì»¬ë ‰ì…˜
        match /voting/{votingId} {
          allow read: if isSameClass(classCode) || isAdmin();
          allow create: if isSignedIn() && isSameClass(classCode);
          allow update: if isSignedIn() && isSameClass(classCode);
          allow delete: if isAdmin();
        }
      }

      // âš–ï¸ ì¬íŒ ê²°ê³¼ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/trialResults/{resultId})
      match /trialResults/{resultId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && isOwner(request.resource.data.judgeId);
        allow update: if isAdmin();
        allow delete: if isAdmin();
      }

      // ğŸ”¥ í™œë™ ë¡œê·¸ ì„œë¸Œì»¬ë ‰ì…˜ (classes/{classCode}/activityLogs/{logId})
      match /activityLogs/{logId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow create: if isSignedIn() && isSameClass(classCode);
        allow update: if false; // ë¡œê·¸ëŠ” ìˆ˜ì • ë¶ˆê°€
        allow delete: if isAdmin();
      }
    }

    // ========================================================
    // ğŸ’³ êµ­ì„¸ì²­ (taxRecords)
    // ========================================================
    match /taxRecords/{recordId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isSignedIn(); // ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ìê°€ ì„¸ê¸ˆ ê¸°ë¡ ìƒì„± ê°€ëŠ¥
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ’° êµ­ê³  (treasury) - ë£¨íŠ¸ ë ˆë²¨
    // ========================================================
    match /treasury/{classCode} {
      // ì½ê¸°: ê°™ì€ í•™ê¸‰ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isSameClass(classCode) || isAdmin();

      // ìƒì„±: ê´€ë¦¬ì ë˜ëŠ” ê°™ì€ í•™ê¸‰ ì‚¬ìš©ì (ì´ˆê¸° ìƒì„± ì‹œ)
      allow create: if isAdmin() || isSameClass(classCode);

      // ìˆ˜ì •: ê´€ë¦¬ì ë˜ëŠ” ê°™ì€ í•™ê¸‰ ì‚¬ìš©ì (ì„¸ê¸ˆ ë‚©ë¶€, ê¸ˆê³  ì…ì¶œê¸ˆ ì‹œ)
      allow update: if isAdmin() || isSameClass(classCode);

      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ’° êµ­ê³  (nationalTreasuries) - ì¶”ê°€ëœ ê·œì¹™
    // ========================================================
    match /nationalTreasuries/{classCode} {
      // ì½ê¸°: ê°™ì€ í•™ê¸‰ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isSameClass(classCode) || isAdmin();

      // ìƒì„±: ê´€ë¦¬ì ë˜ëŠ” ê°™ì€ í•™ê¸‰ ì‚¬ìš©ì (ì´ˆê¸° ìƒì„± ì‹œ)
      allow create: if isAdmin() || isSameClass(classCode);

      // ìˆ˜ì •: ê´€ë¦¬ì ë˜ëŠ” ê°™ì€ í•™ê¸‰ ì‚¬ìš©ì (ê¸ˆê³  ì…ì¶œê¸ˆ ì‹œ)
      allow update: if isAdmin() || isSameClass(classCode);

      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ’³ ê±°ë˜ ê¸°ë¡ (transactions) - ë£¨íŠ¸ ë ˆë²¨
    // ========================================================
    match /transactions/{transactionId} {
      // ì½ê¸°: ë³¸ì¸ ê±°ë˜ ë˜ëŠ” ê´€ë¦¬ì
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (ìì‹ ì˜ ê±°ë˜ë§Œ)
      allow create: if isSignedIn();

      // ìˆ˜ì •: ë¶ˆê°€ (ê±°ë˜ ê¸°ë¡ì€ ë¶ˆë³€)
      allow update: if false;

      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸµ ìŒì•… ì‹ ì²­ë°© (musicRooms)
    // ========================================================
    match /musicRooms/{roomId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (í•™ìƒë“¤ì´ ë°© ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆì–´ì•¼ í•¨)
      allow read: if isSignedIn();

      // ìƒì„±: ê´€ë¦¬ìë§Œ (ì„ ìƒë‹˜ë§Œ ë°© ìƒì„± ê°€ëŠ¥)
      allow create: if isAdmin() && isOwner(request.resource.data.teacherId);

      // ìˆ˜ì •: ë°© ìƒì„±ì ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isOwner(resource.data.teacherId) || isAdmin();

      // ì‚­ì œ: ë°© ìƒì„±ì ë˜ëŠ” ê´€ë¦¬ì
      allow delete: if isOwner(resource.data.teacherId) || isAdmin();

      // ì¬ìƒëª©ë¡ ì„œë¸Œì»¬ë ‰ì…˜ (musicRooms/{roomId}/playlist/{songId})
      match /playlist/{songId} {
        // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (í•™ìƒë“¤ë„ ìì‹ ì˜ ì‹ ì²­ê³¡ í™•ì¸)
        allow read: if isSignedIn();

        // ìƒì„±: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (í•™ìƒë“¤ì˜ ìŒì•… ì‹ ì²­)
        allow create: if isSignedIn();

        // ìˆ˜ì •: ë°© ìƒì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ
        allow update: if isOwner(get(/databases/$(database)/documents/musicRooms/$(roomId)).data.teacherId) || isAdmin();

        // ì‚­ì œ: ë°© ìƒì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ (ì¬ìƒ ì™„ë£Œ ì‹œ)
        allow delete: if isOwner(get(/databases/$(database)/documents/musicRooms/$(roomId)).data.teacherId) || isAdmin();
      }
    }

    // ========================================================
    // ğŸª ê°œì¸ ìƒì  (personalShops)
    // ========================================================
    match /personalShops/{shopId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì (ìƒì  ëª©ë¡ ì¡°íšŒ)
      allow read: if isSignedIn();

      // ìƒì„±: ë³¸ì¸ ìƒì ë§Œ
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;

      // ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow update: if isOwner(resource.data.ownerId) || isAdmin();

      // ì‚­ì œ: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow delete: if isOwner(resource.data.ownerId) || isAdmin();
    }

    // ========================================================
    // ğŸ“¦ ìƒì  ìƒí’ˆ (shopProducts)
    // ========================================================
    match /shopProducts/{productId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì
      allow read: if isSignedIn();

      // ìƒì„±: ìƒì  ì†Œìœ ì
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;

      // ìˆ˜ì •: ìƒí’ˆ ì†Œìœ ì/ê´€ë¦¬ìëŠ” ì „ì²´ ìˆ˜ì •, êµ¬ë§¤ìëŠ” ì¬ê³ /íŒë§¤ ê´€ë ¨ í•„ë“œë§Œ
      allow update: if isOwner(resource.data.ownerId) || isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stock', 'soldCount', 'buyers', 'updatedAt']));

      // ì‚­ì œ: ìƒí’ˆ ì†Œìœ ì ë˜ëŠ” ê´€ë¦¬ì
      allow delete: if isOwner(resource.data.ownerId) || isAdmin();
    }

    // ========================================================
    // ğŸ“œ í™œë™ ê¸°ë¡ (activities)
    // ========================================================
    match /activities/{activityId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow read: if isSignedIn();

      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow create: if isSignedIn();

      // ìˆ˜ì •: ë¶ˆê°€
      allow update: if false;

      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ’° êµ­ì„¸ì²­ (nationalTax)
    // ========================================================
    match /nationalTax/{docId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
      allow read: if isSignedIn();

      // ìƒì„±: ê´€ë¦¬ì
      allow create: if isAdmin();

      // ìˆ˜ì •: ê´€ë¦¬ì ì „ì²´ ìˆ˜ì •, ì¼ë°˜ ì‚¬ìš©ìëŠ” ì„¸ê¸ˆ ë‚©ë¶€ ê´€ë ¨ í•„ë“œë§Œ
      allow update: if isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['payments', 'totalPaid', 'lastPaidAt', 'updatedAt']));

      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }

    // ========================================================
    // âš¡ ê²½ì œ ì´ë²¤íŠ¸ - í™œì„± ì´ë²¤íŠ¸ íŒì—… (activeEconomicEvent)
    // í´ë¼ìš°ë“œ í•¨ìˆ˜ê°€ ì“°ê¸°, ê°™ì€ í•™ê¸‰ ì‚¬ìš©ìê°€ ì½ê¸° (íŒì—… í‘œì‹œìš©)
    // ========================================================
    match /activeEconomicEvent/{classCode} {
      allow read: if isSameClass(classCode) || isAdmin();
      allow write: if isAdmin();
    }

    // ========================================================
    // âš¡ ê²½ì œ ì´ë²¤íŠ¸ ì„¤ì • (economicEventSettings)
    // ========================================================
    match /economicEventSettings/{classCode} {
      allow read: if isSameClass(classCode) || isAdmin();
      allow write: if isAdmin();
    }

    // ========================================================
    // ğŸ“‹ ê²½ì œ ì´ë²¤íŠ¸ ë¡œê·¸ (economicEventLogs)
    // ========================================================
    match /economicEventLogs/{classCode} {
      allow read: if isSameClass(classCode) || isAdmin();
      allow write: if isAdmin();

      match /entries/{entryId} {
        allow read: if isSameClass(classCode) || isAdmin();
        allow write: if isAdmin();
      }
    }

    // ========================================================
    // âœ… ë³´ë„ˆìŠ¤ í• ì¼ ìŠ¹ì¸ ìš”ì²­ (pendingApprovals)
    // ========================================================
    match /pendingApprovals/{approvalId} {
      allow read: if isSignedIn() && (isSameClass(resource.data.classCode) || isAdmin());
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================
    // ğŸ¤ í•¨ê»˜êµ¬ë§¤ (groupPurchases)
    // ========================================================
    match /groupPurchases/{purchaseId} {
      allow read: if isSignedIn() && isSameClass(resource.data.classCode);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isSameClass(resource.data.classCode);
      allow delete: if isOwner(resource.data.initiatorId) || isAdmin();
    }

    // ========================================================
    // ğŸš« ê¸°íƒ€ ëª¨ë“  ì»¬ë ‰ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì°¨ë‹¨
    // ========================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
