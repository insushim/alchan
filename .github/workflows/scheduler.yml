name: Scheduled Tasks

on:
  # ðŸ”¥ ìžë™ ìŠ¤ì¼€ì¤„ ë¹„í™œì„±í™”: cron-job.orgë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  # schedule:
  #   - cron: '*/15 * * * *'

  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš© (ê¸´ê¸‰ ìƒí™©ìš©)
  workflow_dispatch:

jobs:
  run-scheduled-functions:
    runs-on: ubuntu-latest

    steps:
      - name: Determine tasks to run
        id: tasks
        run: |
          MINUTE=$(date -u +%M)
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u) # 1=Monday, 7=Sunday

          # KST ì‹œê°„ ë° ìš”ì¼ ê³„ì‚° (UTC+9)
          KST_HOUR=$(( (HOUR + 9) % 24 ))
          if [ $HOUR -ge 15 ]; then
            KST_DAY=$(( (DAY % 7) + 1 ))
          else
            KST_DAY=$DAY
          fi

          TASKS=""
          IS_MARKET_HOURS=false

          # í‰ì¼(ì›”-ê¸ˆ, 1-5) 8ì‹œ-15ì‹œ KST ì‹œìž¥ ì‹œê°„ì—ë§Œ ì‹¤í–‰
          if [ $KST_DAY -ge 1 ] && [ $KST_DAY -le 5 ] && [ $KST_HOUR -ge 8 ] && [ $KST_HOUR -lt 15 ]; then
            IS_MARKET_HOURS=true
            TASKS="\"updateMarketCondition\",\"updateCentralStockMarket\",\"createCentralMarketNews\",\"cleanupExpiredCentralNews\",\"autoManageStocks\""
          else
            # ì‹œìž¥ ì‹œê°„ ì™¸ì—ëŠ” ë¶ˆí•„ìš”í•œ ìž‘ì—… ì‹¤í–‰ ì•ˆí•¨
            TASKS=""
          fi

          # ì¼ì¼ ìž‘ì—… ë¦¬ì…‹ (ë§¤ì¼ ìžì • KST ë¶€ê·¼)
          if [ $KST_HOUR -eq 0 ] && [ $MINUTE -lt 5 ]; then
            if [ -n "$TASKS" ]; then TASKS="$TASKS,"; fi
            TASKS="${TASKS}\"resetDailyTasks\""
          fi

          TASKS_ARRAY="[${TASKS}]"
          if [ -z "$TASKS" ]; then
            TASKS_ARRAY="[]"
          fi

          echo "tasks=${TASKS_ARRAY}" >> $GITHUB_OUTPUT
          echo "KST Time: ${KST_HOUR}:${MINUTE} (Day: ${KST_DAY})"
          echo "Is Market Hours: $IS_MARKET_HOURS"
          echo "Tasks to run: $TASKS_ARRAY"

      - name: Call Firebase Function
        if: steps.tasks.outputs.tasks != '[]'
        env:
          TASKS_JSON: ${{ steps.tasks.outputs.tasks }}
          AUTH_TOKEN: "github-actions-scheduler-2024"
        run: |
          echo "Calling runScheduler with tasks: ${TASKS_JSON}"
          RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AUTH_TOKEN}" \
            -d "{\"tasks\": ${TASKS_JSON}}" \
            -w "\nHTTP_STATUS:%{http_code}" \
            "https://runscheduler-j7kazbsvxq-du.a.run.app")

          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
          echo "HTTP Status: $HTTP_STATUS"
          echo "Response: $(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')"

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: Scheduler call failed with status $HTTP_STATUS"
            exit 1
          fi