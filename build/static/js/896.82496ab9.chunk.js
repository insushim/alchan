"use strict";(self.webpackChunkinconomysu_class=self.webpackChunkinconomysu_class||[]).push([[896],{2896(t,s,e){e.r(s),e.d(s,{default:()=>d});var a=e(2555),i=e(5043),o=e(5016),n=e(2864),r=e(5472),c=e(579);const l=t=>{let{title:s,status:e,message:a,data:i}=t,o="";return"SUCCESS"===e?o="status-success":"FAILURE"===e?o="status-failure":"PENDING"===e&&(o="status-pending"),(0,c.jsxs)("div",{className:"test-result",children:[(0,c.jsx)("h4",{children:s}),(0,c.jsxs)("p",{children:[(0,c.jsx)("strong",{children:"Status:"})," ",(0,c.jsx)("span",{className:o,children:e})]}),(0,c.jsxs)("p",{children:[(0,c.jsx)("strong",{children:"Message:"})," ",a]}),i&&(0,c.jsx)("pre",{children:JSON.stringify(i,null,2)})]})};function d(){const{user:t,userDoc:s,isAdmin:e}=(0,o.As)(),[d,u]=(0,i.useState)([]),[g,m]=(0,i.useState)(!1),[h,v]=(0,i.useState)(null),f=null===s||void 0===s?void 0:s.classCode,S=f?"".concat(f,"_goal"):null,N=null===t||void 0===t?void 0:t.uid,C=t=>{u(s=>[...s,t])};return(0,c.jsxs)("div",{className:"firestore-doctor",children:[(0,c.jsx)("h2",{children:"Firestore Doctor: Diagnostic Page"}),(0,c.jsx)("p",{children:"This page runs a series of tests to diagnose the data inconsistency issue."}),(0,c.jsx)("p",{children:"Click the button below to start the tests. The results will appear below."}),(0,c.jsx)("button",{onClick:async()=>{if(m(!0),u([]),C({title:"1. Initial State",status:"PENDING",message:"Checking initial user and goal state..."}),!t||!N)return C({title:"1. Initial State",status:"FAILURE",message:"User is not logged in."}),void m(!1);if(!f||!S)return C({title:"1. Initial State",status:"FAILURE",message:"User is missing classCode. Current classCode: ".concat(f)}),void m(!1);C({title:"1. Initial State",status:"SUCCESS",message:"User, UID, and classCode are present.",data:{userId:N,classCode:f,goalId:S,isAdmin:e()}});const s=(0,r.H9)(n.db,"users",N),a=(0,r.H9)(n.db,"goals",S),i="doctorTest_".concat(Date.now()),o={[i]:"write_test_successful"};try{var c;C({title:"2. User Doc Write Test",status:"PENDING",message:"Attempting to write to your user document..."}),await(0,r.BN)(s,o,{merge:!0});if("write_test_successful"!==(null===(c=(await(0,r.x7)(s)).data())||void 0===c?void 0:c[i]))throw new Error("Write verification failed.");C({title:"2. User Doc Write Test",status:"SUCCESS",message:"Successfully wrote to and verified user document."})}catch(v){return C({title:"2. User Doc Write Test",status:"FAILURE",message:v.message,data:v}),void m(!1)}try{var l;C({title:"3. Goal Doc Write Test",status:"PENDING",message:"Attempting to write to goals document: ".concat(S)}),await(0,r.BN)(a,o,{merge:!0});if("write_test_successful"!==(null===(l=(await(0,r.x7)(a)).data())||void 0===l?void 0:l[i]))throw new Error("Write verification failed.");C({title:"3. Goal Doc Write Test",status:"SUCCESS",message:"Successfully wrote to and verified goal document."})}catch(v){return C({title:"3. Goal Doc Write Test",status:"FAILURE",message:v.message,data:v}),void m(!1)}const d="doctorTransactionTest_".concat(Date.now());try{C({title:"4. Atomic Transaction Test",status:"PENDING",message:"Running a transaction to write to both documents..."}),await(0,r.c4)(n.db,async t=>{t.set(s,{[d]:"transaction_successful"},{merge:!0}),t.set(a,{[d]:"transaction_successful"},{merge:!0})}),C({title:"4. Atomic Transaction Test",status:"SUCCESS",message:"Firestore reported transaction as successful."})}catch(v){return C({title:"4. Atomic Transaction Test",status:"FAILURE",message:"Firestore reported transaction as FAILED: ".concat(v.message),data:v}),void m(!1)}try{var g,h;C({title:"5. Final Verification",status:"PENDING",message:"Verifying transaction results..."});const t=await(0,r.x7)(s),e=await(0,r.x7)(a),i="transaction_successful"===(null===(g=t.data())||void 0===g?void 0:g[d]),o="transaction_successful"===(null===(h=e.data())||void 0===h?void 0:h[d]);C(i&&o?{title:"5. Final Verification",status:"SUCCESS",message:"Both documents were successfully updated by the transaction."}:{title:"5. Final Verification",status:"FAILURE",message:"Data inconsistency detected! The transaction was not atomic.",data:{userDocumentUpdated:i,goalDocumentUpdated:o,userData:t.data(),goalData:e.data()}})}catch(v){C({title:"5. Final Verification",status:"FAILURE",message:v.message,data:v})}m(!1)},disabled:g,children:g?"Running Tests...":"Start Diagnostic Tests"}),(0,c.jsx)("hr",{}),(0,c.jsx)("div",{className:"results-container",children:d.map((t,s)=>(0,c.jsx)(l,(0,a.A)({},t),s))}),(0,c.jsx)("hr",{}),(0,c.jsx)("h2",{children:"Data Recovery"}),(0,c.jsx)("p",{children:"Click the button below to restore the goal progress and donation history from the activity logs. This should only be run once."}),(0,c.jsx)("button",{onClick:async()=>{if(e())if(f){v({status:"PENDING",message:"Starting client-side data recovery..."});try{const t=(0,r.query)((0,r.rJ)(n.db,"activity_logs"),(0,r.where)("classCode","==",f),(0,r.where)("type","==","\ucfe0\ud3f0 \uae30\ubd80"));v({status:"PENDING",message:"Fetching donation logs..."});const s=await(0,r.getDocs)(t);if(s.empty)return void v({status:"SUCCESS",message:"No donation logs found for class ".concat(f,". Nothing to recover.")});v({status:"PENDING",message:"Found ".concat(s.size," donation logs. Processing...")});let e=0;const a=[];s.forEach(t=>{var s;const i=t.data(),o=(null===(s=i.metadata)||void 0===s?void 0:s.amount)||0;var n;o>0&&(e+=o,a.push({id:t.id,userId:i.userId,userName:i.userName,amount:o,message:(null===(n=i.metadata)||void 0===n?void 0:n.message)||"",timestamp:i.timestamp,classCode:i.classCode}))}),a.sort((t,s)=>t.timestamp.toMillis()-s.timestamp.toMillis());const i=(0,r.H9)(n.db,"goals",S);v({status:"PENDING",message:"Writing recovered data to goal document..."}),await(0,r.BN)(i,{progress:e,donations:a,donationCount:a.length,updatedAt:(0,r.O5)(),lastRecoveryAt:(0,r.O5)()},{merge:!0}),v({status:"SUCCESS",message:"Client-side recovery successful for ".concat(f,"."),data:{recoveredProgress:e,recoveredDonationCount:a.length}})}catch(t){v({status:"FAILURE",message:t.message,data:t})}}else v({status:"FAILURE",message:"No classCode found."});else v({status:"FAILURE",message:"Only admins can perform data recovery."})},disabled:"PENDING"===(null===h||void 0===h?void 0:h.status),children:"PENDING"===(null===h||void 0===h?void 0:h.status)?"Recovering Data...":"Start Data Recovery"}),h&&(0,c.jsx)(l,(0,a.A)({title:"Recovery Status"},h))]})}}}]);
//# sourceMappingURL=896.82496ab9.chunk.js.map