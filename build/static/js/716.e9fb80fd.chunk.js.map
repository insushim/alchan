{"version":3,"file":"static/js/716.e9fb80fd.chunk.js","mappings":"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","sources":["pages/admin/RecoverDonations.js"],"sourcesContent":["// src/pages/admin/RecoverDonations.js - ê¸°ë¶€ ë‚´ì—­ ë³µêµ¬ ìœ í‹¸ë¦¬í‹°\r\nimport React, { useState } from \"react\";\r\nimport { useAuth } from \"../../contexts/AuthContext\";\r\nimport { logger } from \"../../utils/logger\";\nimport {\r\n  db,\r\n  collection,\r\n  query,\r\n  where,\r\n  getDocs,\r\n  doc,\r\n  getDoc,\r\n  writeBatch,\r\n  serverTimestamp,\r\n} from \"../../firebase\";\r\n\r\nexport default function RecoverDonations() {\r\n  const { user, userDoc } = useAuth();\r\n  const [recovering, setRecovering] = useState(false);\r\n  const [log, setLog] = useState([]);\r\n\r\n  const addLog = (message) => {\r\n    logger.log(message);\r\n    setLog(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${message}`]);\r\n  };\r\n\r\n  const recoverDonationsFromCollection = async () => {\r\n    if (!userDoc?.isAdmin && !userDoc?.isSuperAdmin) {\r\n      alert(\"ê´€ë¦¬ìë§Œ ë³µêµ¬ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\");\r\n      return;\r\n    }\r\n\r\n    const classCode = userDoc?.classCode;\r\n    if (!classCode) {\r\n      alert(\"í•™ê¸‰ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.\");\r\n      return;\r\n    }\r\n\r\n    if (!window.confirm(`${classCode} í•™ê¸‰ì˜ ê¸°ë¶€ ë‚´ì—­ì„ donations ì»¬ë ‰ì…˜ì—ì„œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {\r\n      return;\r\n    }\r\n\r\n    setRecovering(true);\r\n    setLog([]);\r\n    addLog(\"ë³µêµ¬ ì‘ì—… ì‹œì‘...\");\r\n\r\n    try {\r\n      // 1. donations ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ í•™ê¸‰ì˜ ëª¨ë“  ê¸°ë¶€ ê¸°ë¡ ì¡°íšŒ\r\n      addLog(`donations ì»¬ë ‰ì…˜ì—ì„œ ${classCode} í•™ê¸‰ ë°ì´í„° ì¡°íšŒ ì¤‘...`);\r\n      const donationsQuery = query(\r\n        collection(db, \"donations\"),\r\n        where(\"classCode\", \"==\", classCode)\r\n      );\r\n      const donationsSnapshot = await getDocs(donationsQuery);\r\n\r\n      if (donationsSnapshot.empty) {\r\n        addLog(\"âŒ donations ì»¬ë ‰ì…˜ì—ì„œ ë³µêµ¬ ê°€ëŠ¥í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\");\r\n        alert(\"ë³µêµ¬ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\");\r\n        setRecovering(false);\r\n        return;\r\n      }\r\n\r\n      addLog(`âœ… ${donationsSnapshot.size}ê°œì˜ ê¸°ë¶€ ê¸°ë¡ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);\r\n\r\n      // 2. ê¸°ë¶€ ê¸°ë¡ì„ ë°°ì—´ë¡œ ë³€í™˜\r\n      const donations = [];\r\n      let totalAmount = 0;\r\n      const userContributions = {};\r\n\r\n      donationsSnapshot.forEach((donationDoc) => {\r\n        const data = donationDoc.data();\r\n        const donation = {\r\n          userId: data.userId,\r\n          userName: data.userName,\r\n          amount: Number(data.amount) || 0,\r\n          message: data.message || \"\",\r\n          timestamp: data.timestamp,\r\n          timestampISO: data.timestampISO || (data.timestamp ? data.timestamp.toDate().toISOString() : new Date().toISOString()),\r\n          classCode: data.classCode,\r\n        };\r\n\r\n        donations.push(donation);\r\n        totalAmount += donation.amount;\r\n\r\n        // ì‚¬ìš©ìë³„ ê¸°ì—¬ë„ ê³„ì‚°\r\n        if (!userContributions[donation.userId]) {\r\n          userContributions[donation.userId] = 0;\r\n        }\r\n        userContributions[donation.userId] += donation.amount;\r\n\r\n        addLog(`  - ${donation.userName}: ${donation.amount}ì¿ í°`);\r\n      });\r\n\r\n      addLog(`ğŸ“Š ì´ ê¸°ë¶€ì•¡: ${totalAmount}ì¿ í°`);\r\n      addLog(`ğŸ‘¥ ê¸°ë¶€ì ìˆ˜: ${Object.keys(userContributions).length}ëª…`);\r\n\r\n      // 3. goals ë¬¸ì„œ ì—…ë°ì´íŠ¸\r\n      const goalId = `${classCode}_goal`;\r\n      const goalRef = doc(db, \"goals\", goalId);\r\n      const goalDoc = await getDoc(goalRef);\r\n\r\n      if (!goalDoc.exists()) {\r\n        addLog(\"âŒ ëª©í‘œ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ëª©í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.\");\r\n        alert(\"ëª©í‘œ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\");\r\n        setRecovering(false);\r\n        return;\r\n      }\r\n\r\n      addLog(`ğŸ¯ ëª©í‘œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì¤‘...`);\r\n      const batch = writeBatch(db);\r\n\r\n      // goals ë¬¸ì„œì— donations ë°°ì—´ê³¼ progress ì—…ë°ì´íŠ¸\r\n      batch.update(goalRef, {\r\n        donations: donations,\r\n        progress: totalAmount,\r\n        donationCount: donations.length,\r\n        updatedAt: serverTimestamp(),\r\n        recoveredAt: serverTimestamp(),\r\n        recoveredBy: user.uid,\r\n      });\r\n\r\n      // 4. ê° ì‚¬ìš©ìì˜ myContribution ì—…ë°ì´íŠ¸\r\n      addLog(`ğŸ‘¤ ì‚¬ìš©ì ê¸°ì—¬ë„ ì—…ë°ì´íŠ¸ ì¤‘...`);\r\n      for (const [userId, contribution] of Object.entries(userContributions)) {\r\n        const userRef = doc(db, \"users\", userId);\r\n        batch.update(userRef, {\r\n          myContribution: contribution,\r\n          updatedAt: serverTimestamp(),\r\n        });\r\n        addLog(`  - ${userId}: ${contribution}ì¿ í°`);\r\n      }\r\n\r\n      // 5. ì¼ê´„ ì»¤ë°‹\r\n      await batch.commit();\r\n      addLog(`âœ… ë³µêµ¬ ì™„ë£Œ!`);\r\n      addLog(`ğŸ“ ì´ ${donations.length}ê°œì˜ ê¸°ë¶€ ê¸°ë¡ ë³µêµ¬ë¨`);\r\n      addLog(`ğŸ’° ì´ ê¸°ë¶€ì•¡: ${totalAmount}ì¿ í°`);\r\n\r\n      alert(`ê¸°ë¶€ ë‚´ì—­ ë³µêµ¬ ì™„ë£Œ!\\nì´ ${donations.length}ê°œ ê¸°ë¡, ${totalAmount}ì¿ í°`);\r\n\r\n    } catch (error) {\r\n      logger.error(\"ë³µêµ¬ ì‹¤íŒ¨:\", error);\r\n      addLog(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);\r\n      alert(`ë³µêµ¬ ì‹¤íŒ¨: ${error.message}`);\r\n    } finally {\r\n      setRecovering(false);\r\n    }\r\n  };\r\n\r\n  if (!user) {\r\n    return (\r\n      <div style={{ padding: \"20px\", textAlign: \"center\" }}>\r\n        ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!userDoc?.isAdmin && !userDoc?.isSuperAdmin) {\r\n    return (\r\n      <div style={{ padding: \"20px\", textAlign: \"center\", color: \"#ef4444\" }}>\r\n        ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div style={{\r\n      padding: \"20px\",\r\n      maxWidth: \"800px\",\r\n      margin: \"0 auto\",\r\n      fontFamily: \"'Noto Sans KR', sans-serif\"\r\n    }}>\r\n      <h2 style={{\r\n        fontSize: \"24px\",\r\n        fontWeight: \"bold\",\r\n        color: \"#ef4444\",\r\n        borderBottom: \"2px solid #fecaca\",\r\n        paddingBottom: \"10px\",\r\n        marginBottom: \"20px\"\r\n      }}>\r\n        ğŸš¨ ê¸°ë¶€ ë‚´ì—­ ë³µêµ¬ ë„êµ¬\r\n      </h2>\r\n\r\n      <div style={{\r\n        backgroundColor: \"#fef2f2\",\r\n        border: \"1px solid #fecaca\",\r\n        borderRadius: \"8px\",\r\n        padding: \"15px\",\r\n        marginBottom: \"20px\"\r\n      }}>\r\n        <h3 style={{ fontSize: \"16px\", fontWeight: \"600\", marginBottom: \"10px\" }}>\r\n          âš ï¸ ì£¼ì˜ì‚¬í•­\r\n        </h3>\r\n        <ul style={{ fontSize: \"14px\", lineHeight: \"1.6\", paddingLeft: \"20px\" }}>\r\n          <li>ì´ ë„êµ¬ëŠ” donations ì»¬ë ‰ì…˜ì—ì„œ ê¸°ë¶€ ë‚´ì—­ì„ ë³µêµ¬í•©ë‹ˆë‹¤.</li>\r\n          <li>í˜„ì¬ goals ë¬¸ì„œì˜ donations ë°°ì—´ì´ ë®ì–´ì¨ì§‘ë‹ˆë‹¤.</li>\r\n          <li>ë³µêµ¬ ì „ì— ë°˜ë“œì‹œ í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ì„¸ìš”.</li>\r\n          <li>ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>\r\n        </ul>\r\n      </div>\r\n\r\n      <button\r\n        onClick={recoverDonationsFromCollection}\r\n        disabled={recovering}\r\n        style={{\r\n          width: \"100%\",\r\n          padding: \"15px\",\r\n          backgroundColor: recovering ? \"#9ca3af\" : \"#ef4444\",\r\n          color: \"white\",\r\n          border: \"none\",\r\n          borderRadius: \"8px\",\r\n          fontSize: \"16px\",\r\n          fontWeight: \"600\",\r\n          cursor: recovering ? \"not-allowed\" : \"pointer\",\r\n          marginBottom: \"20px\"\r\n        }}\r\n      >\r\n        {recovering ? \"ë³µêµ¬ ì¤‘...\" : \"ğŸ”„ ê¸°ë¶€ ë‚´ì—­ ë³µêµ¬ ì‹œì‘\"}\r\n      </button>\r\n\r\n      {log.length > 0 && (\r\n        <div style={{\r\n          backgroundColor: \"#1f2937\",\r\n          color: \"#f3f4f6\",\r\n          borderRadius: \"8px\",\r\n          padding: \"15px\",\r\n          maxHeight: \"400px\",\r\n          overflowY: \"auto\",\r\n          fontFamily: \"monospace\",\r\n          fontSize: \"13px\"\r\n        }}>\r\n          <h3 style={{\r\n            fontSize: \"14px\",\r\n            fontWeight: \"600\",\r\n            marginBottom: \"10px\",\r\n            color: \"#60a5fa\"\r\n          }}>\r\n            ğŸ“‹ ì‘ì—… ë¡œê·¸\r\n          </h3>\r\n          {log.map((entry, index) => (\r\n            <div key={index} style={{ marginBottom: \"5px\" }}>\r\n              {entry}\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":["RecoverDonations","user","userDoc","useAuth","recovering","setRecovering","useState","log","setLog","addLog","message","logger","prev","concat","Date","toLocaleTimeString","isAdmin","isSuperAdmin","_jsxs","style","padding","maxWidth","margin","fontFamily","children","_jsx","fontSize","fontWeight","color","borderBottom","paddingBottom","marginBottom","backgroundColor","border","borderRadius","lineHeight","paddingLeft","onClick","async","alert","classCode","window","confirm","donationsQuery","query","collection","db","where","donationsSnapshot","getDocs","empty","size","donations","totalAmount","userContributions","forEach","donationDoc","data","donation","userId","userName","amount","Number","timestamp","timestampISO","toDate","toISOString","push","Object","keys","length","goalId","goalRef","doc","getDoc","exists","batch","writeBatch","update","progress","donationCount","updatedAt","serverTimestamp","recoveredAt","recoveredBy","uid","contribution","entries","userRef","myContribution","commit","error","disabled","width","cursor","maxHeight","overflowY","map","entry","index","textAlign"],"ignoreList":[],"sourceRoot":""}