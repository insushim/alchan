{"version":3,"file":"static/js/251.0fc762cc.chunk.js","mappings":"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","sources":["database.js"],"sourcesContent":["// src/database.js\r\nimport {\r\n  addActivityLog,\r\n  getUserDocument,\r\n  updateUserCashInFirestore,\r\n  updateUserCouponsInFirestore,\r\n  addTransaction as firebaseAddTransaction,\r\n  db,\r\n  writeBatch,\r\n  doc,\r\n  collection,\r\n  serverTimestamp,\r\n  updateUserDocument // ì¶”ê°€ëœ import\r\n} from './firebase';\r\nimport { applyTransactionTax, applyIncomeTax } from './utils/taxUtils';\r\n\r\n/**\r\n * í™œë™ ë¡œê·¸ íƒ€ì… ì •ì˜\r\n */\r\nconst LOG_TYPES = {\r\n  // í˜„ê¸ˆ ê´€ë ¨\r\n  CASH_INCOME: 'í˜„ê¸ˆ ì…ê¸ˆ',\r\n  CASH_EXPENSE: 'í˜„ê¸ˆ ì¶œê¸ˆ',\r\n  CASH_TRANSFER_SEND: 'ì†¡ê¸ˆ',\r\n  CASH_TRANSFER_RECEIVE: 'ì†¡ê¸ˆ ìˆ˜ì‹ ',\r\n  ADMIN_CASH_SEND: 'ê´€ë¦¬ì ì§€ê¸‰',\r\n  ADMIN_CASH_TAKE: 'ê´€ë¦¬ì íšŒìˆ˜',\r\n\r\n  // ì¿ í° ê´€ë ¨\r\n  COUPON_EARN: 'ì¿ í° íšë“',\r\n  COUPON_USE: 'ì¿ í° ì‚¬ìš©',\r\n  COUPON_GIVE: 'ì¿ í° ì§€ê¸‰',\r\n  COUPON_TAKE: 'ì¿ í° íšŒìˆ˜',\r\n  COUPON_TRANSFER_SEND: 'ì¿ í° ì†¡ê¸ˆ',\r\n  COUPON_TRANSFER_RECEIVE: 'ì¿ í° ìˆ˜ì‹ ',\r\n\r\n  // ì•„ì´í…œ ê´€ë ¨\r\n  ITEM_PURCHASE: 'ì•„ì´í…œ êµ¬ë§¤',\r\n  ITEM_USE: 'ì•„ì´í…œ ì‚¬ìš©', // ì•„ì´í…œ ì‚¬ìš© ë¡œê·¸ íƒ€ì…\r\n  ITEM_SELL: 'ì•„ì´í…œ íŒë§¤',\r\n  ITEM_MARKET_LIST: 'ì•„ì´í…œ ì‹œì¥ ë“±ë¡',\r\n  ITEM_MARKET_BUY: 'ì•„ì´í…œ ì‹œì¥ êµ¬ë§¤',\r\n  ITEM_OBTAIN: 'ì•„ì´í…œ íšë“',\r\n  ITEM_MOVE: 'ì•„ì´í…œ ì´ë™',\r\n\r\n  // ê³¼ì œ ê´€ë ¨\r\n  TASK_COMPLETE: 'ê³¼ì œ ì™„ë£Œ',\r\n  TASK_REWARD: 'ê³¼ì œ ë³´ìƒ',\r\n\r\n  // ê²Œì„ ê´€ë ¨\r\n  GAME_WIN: 'ê²Œì„ ìŠ¹ë¦¬',\r\n  GAME_LOSE: 'ê²Œì„ íŒ¨ë°°',\r\n  GAME_REWARD: 'ê²Œì„ ë³´ìƒ',\r\n  OMOK_GAME: 'ì˜¤ëª© ê²Œì„',\r\n  CHESS_GAME: 'ì²´ìŠ¤ ê²Œì„',\r\n\r\n  // ì£¼ì‹ ê´€ë ¨\r\n  STOCK_BUY: 'ì£¼ì‹ ë§¤ìˆ˜',\r\n  STOCK_SELL: 'ì£¼ì‹ ë§¤ë„',\r\n\r\n  // ì„¸ê¸ˆ ê´€ë ¨\r\n  TAX_PAYMENT: 'ì„¸ê¸ˆ ë‚©ë¶€',\r\n  TAX_REFUND: 'ì„¸ê¸ˆ í™˜ê¸‰',\r\n  FINE_PAYMENT: 'ë²Œê¸ˆ ë‚©ë¶€',\r\n\r\n  // ê¸‰ì—¬ ê´€ë ¨\r\n  SALARY_PAYMENT: 'ì›”ê¸‰ ì§€ê¸‰',\r\n  BONUS_PAYMENT: 'ë³´ë„ˆìŠ¤ ì§€ê¸‰',\r\n\r\n  // ì‹œìŠ¤í…œ ê´€ë ¨\r\n  SYSTEM: 'ì‹œìŠ¤í…œ',\r\n  ADMIN_ACTION: 'ê´€ë¦¬ì ì¡°ì¹˜',\r\n  TREASURY_DEPOSIT: 'ê¸ˆê³  ì…ê¸ˆ',\r\n  TREASURY_WITHDRAW: 'ê¸ˆê³  ì¶œê¸ˆ',\r\n};\r\n\r\n/**\r\n * ì²´ê³„ì ì¸ í™œë™ ë¡œê±°\r\n * @param {string} userId - ì‚¬ìš©ì ID\r\n * @param {string} type - í™œë™ ìœ í˜• (LOG_TYPES ì°¸ì¡°)\r\n * @param {string} description - í™œë™ ì„¤ëª…\r\n * @param {object} metadata - ì¶”ê°€ ë©”íƒ€ë°ì´í„°\r\n */\r\nconst logActivity = async (userId, type, description, metadata = {}) => {\r\n  if (!userId || userId === 'system') {\r\n    console.log(`[System Log] ${type}: ${description}`);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Firebaseì— í™œë™ ë¡œê·¸ ê¸°ë¡ (ë©”íƒ€ë°ì´í„° í¬í•¨)\r\n    await addActivityLog(userId, type, description, metadata);\r\n\r\n    // ë©”íƒ€ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì½˜ì†”ì—ë„ ê¸°ë¡\r\n    if (Object.keys(metadata).length > 0) {\r\n      console.log(`[Activity Log] User: ${userId}, Type: ${type}`, metadata);\r\n    }\r\n  } catch (error) {\r\n    console.error('[Activity Log Error]', error);\r\n  }\r\n};\r\n\r\n/**\r\n * ê´€ë¦¬ì í˜„ê¸ˆ ì§€ê¸‰/íšŒìˆ˜ (MoneyTransfer.jsìš©) - ìˆ˜ì • ë²„ì „\r\n * @param {object} params - í•¨ìˆ˜ íŒŒë¼ë¯¸í„°\r\n * @param {string} params.adminName - ê´€ë¦¬ì ì´ë¦„\r\n * @param {string} params.adminClassCode - ê´€ë¦¬ì í•™ê¸‰ ì½”ë“œ\r\n * @param {Array<object>} params.targetUsers - ëŒ€ìƒ ì‚¬ìš©ì ì •ë³´ ë°°ì—´\r\n * @param {string} params.action - 'send' ë˜ëŠ” 'take'\r\n * @param {string} params.amountType - 'fixed' ë˜ëŠ” 'percentage'\r\n * @param {number} params.amount - ê¸ˆì•¡ ë˜ëŠ” í¼ì„¼íŠ¸\r\n * @param {number} params.taxRate - ì„¸ìœ¨\r\n */\r\nexport const adminCashAction = async ({\r\n  adminName,\r\n  adminClassCode,\r\n  targetUsers,\r\n  action,\r\n  takeMode, // \"toMe\" ë˜ëŠ” \"remove\"\r\n  amountType,\r\n  amount,\r\n  taxRate,\r\n}) => {\r\n  console.log('[database.js] adminCashAction ì‹œì‘:', {\r\n    adminName,\r\n    action,\r\n    takeMode,\r\n    amountType,\r\n    amount,\r\n    taxRate,\r\n    targetUsersCount: targetUsers.length\r\n  });\r\n\r\n  const batch = writeBatch(db);\r\n  let totalProcessed = 0;\r\n  let successCount = 0;\r\n  const updatedUsers = []; // *** ì¶”ê°€: ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë‹´ì„ ë°°ì—´\r\n\r\n  for (const user of targetUsers) {\r\n    try {\r\n      const currentCash = Number(user.cash || 0);\r\n      let baseAmount;\r\n\r\n      if (amountType === \"percentage\") {\r\n        baseAmount = Math.floor((currentCash * amount) / 100);\r\n      } else {\r\n        baseAmount = Number(amount);\r\n      }\r\n\r\n      if (baseAmount <= 0) {\r\n        console.log(`[database.js] ${user.name}: ì²˜ë¦¬í•  ê¸ˆì•¡ì´ 0ì›ì´ë¯€ë¡œ ìŠ¤í‚µ`);\r\n        continue;\r\n      }\r\n\r\n      let finalAmount = baseAmount;\r\n      let taxAmount = 0;\r\n\r\n      if (action === \"send\" && taxRate > 0) {\r\n        taxAmount = Math.floor((baseAmount * taxRate) / 100);\r\n        finalAmount = baseAmount - taxAmount;\r\n      }\r\n\r\n      let newCash;\r\n      if (action === \"send\") {\r\n        newCash = currentCash + finalAmount;\r\n      } else { // take\r\n        newCash = currentCash - baseAmount;\r\n      }\r\n\r\n      // *** ì¶”ê°€: ë°˜í™˜í•  ë°°ì—´ì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€\r\n      updatedUsers.push({ id: user.id, newCash });\r\n\r\n      console.log(`[database.js] ${user.name} ì²˜ë¦¬:`, {\r\n        í˜„ì¬ì”ì•¡: currentCash,\r\n        ê¸°ë³¸ê¸ˆì•¡: baseAmount,\r\n        ì„¸ê¸ˆ: taxAmount,\r\n        ìµœì¢…ê¸ˆì•¡: finalAmount,\r\n        ìƒˆì”ì•¡: newCash\r\n      });\r\n\r\n      const userRef = doc(db, \"users\", user.id);\r\n      batch.update(userRef, {\r\n        cash: newCash,\r\n        updatedAt: serverTimestamp()\r\n      });\r\n      \r\n      // âœ¨ ìˆ˜ì •ëœ ë¶€ë¶„: totalProcessedëŠ” ì„¸ê¸ˆê³¼ ìƒê´€ì—†ì´ ì‹¤ì œ ì´ë™í•˜ëŠ” ì´ì•¡(baseAmount)ì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤.\r\n      // ì´ë ‡ê²Œ í•´ì•¼ ê´€ë¦¬ì ê³„ì¢Œì—ì„œ ì •í™•í•œ ê¸ˆì•¡ì´ ë¹ ì ¸ë‚˜ê°€ê±°ë‚˜ ë”í•´ì§‘ë‹ˆë‹¤.\r\n      totalProcessed += baseAmount;\r\n      successCount++;\r\n\r\n      const logRef = doc(collection(db, \"activity_logs\"));\r\n      let logType, logDescription;\r\n\r\n      if (action === \"send\") {\r\n        logType = \"ADMIN_CASH_SEND\";\r\n        if (amountType === \"percentage\") {\r\n          logDescription = `ê´€ë¦¬ì(${adminName})ê°€ ${user.name}ë‹˜ì—ê²Œ ${amount}% (${finalAmount.toLocaleString()}ì›)ì„ ì§€ê¸‰í–ˆìŠµë‹ˆë‹¤.`;\r\n          if (taxAmount > 0) {\r\n            logDescription += ` (ì›ê¸ˆ ${baseAmount.toLocaleString()}ì›, ì„¸ê¸ˆ ${taxAmount.toLocaleString()}ì› ì œì™¸)`;\r\n          }\r\n        } else {\r\n          logDescription = `ê´€ë¦¬ì(${adminName})ê°€ ${user.name}ë‹˜ì—ê²Œ ${finalAmount.toLocaleString()}ì›ì„ ì§€ê¸‰í–ˆìŠµë‹ˆë‹¤.`;\r\n          if (taxAmount > 0) {\r\n            logDescription += ` (ì›ê¸ˆ ${baseAmount.toLocaleString()}ì›, ì„¸ê¸ˆ ${taxAmount.toLocaleString()}ì› ì œì™¸)`;\r\n          }\r\n        }\r\n      } else if (action === \"take\") {\r\n        if (takeMode === \"remove\") {\r\n          logType = \"ADMIN_CASH_REMOVE\";\r\n          if (amountType === \"percentage\") {\r\n            logDescription = `ê´€ë¦¬ì(${adminName})ê°€ ${user.name}ë‹˜ì˜ ${amount}% (${baseAmount.toLocaleString()}ì›)ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.`;\r\n          } else {\r\n            logDescription = `ê´€ë¦¬ì(${adminName})ê°€ ${user.name}ë‹˜ì˜ ${baseAmount.toLocaleString()}ì›ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.`;\r\n          }\r\n        } else {\r\n          logType = \"ADMIN_CASH_TAKE\";\r\n          if (amountType === \"percentage\") {\r\n            logDescription = `ê´€ë¦¬ì(${adminName})ê°€ ${user.name}ë‹˜ìœ¼ë¡œë¶€í„° ${amount}% (${baseAmount.toLocaleString()}ì›)ì„ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤.`;\r\n          } else {\r\n            logDescription = `ê´€ë¦¬ì(${adminName})ê°€ ${user.name}ë‹˜ìœ¼ë¡œë¶€í„° ${baseAmount.toLocaleString()}ì›ì„ íšŒìˆ˜í–ˆìŠµë‹ˆë‹¤.`;\r\n          }\r\n        }\r\n      }\r\n\r\n      const logData = {\r\n        userId: user.id,\r\n        userName: user.name,\r\n        timestamp: serverTimestamp(),\r\n        type: logType,\r\n        description: logDescription,\r\n        classCode: adminClassCode,\r\n        metadata: {\r\n          adminName,\r\n          action,\r\n          amountType,\r\n          inputValue: amount,\r\n          taxRate: action === 'send' ? taxRate : 0,\r\n          baseAmount,\r\n          taxAmount,\r\n          finalAmount,\r\n          previousCash: currentCash,\r\n          newCash\r\n        }\r\n      };\r\n      batch.set(logRef, logData);\r\n\r\n      const transactionRef = doc(collection(db, \"transactions\"));\r\n      const transactionData = {\r\n        userId: user.id,\r\n        amount: action === 'send' ? finalAmount : -baseAmount,\r\n        type: action === 'send' ? 'income' : 'expense',\r\n        category: 'admin',\r\n        description: action === 'send' ? 'ê´€ë¦¬ì ì§€ê¸‰' : 'ê´€ë¦¬ì íšŒìˆ˜',\r\n        timestamp: serverTimestamp(),\r\n        metadata: {\r\n          adminName,\r\n          amountType,\r\n          taxRate: action === 'send' ? taxRate : 0\r\n        }\r\n      };\r\n      batch.set(transactionRef, transactionData);\r\n\r\n    } catch (userError) {\r\n      console.error(`[database.js] ì‚¬ìš©ì ${user.name} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, userError);\r\n    }\r\n  }\r\n\r\n  try {\r\n    await batch.commit();\r\n    console.log(`[database.js] adminCashAction ì™„ë£Œ: ${successCount}ëª… ì²˜ë¦¬, ì´ ${totalProcessed.toLocaleString()}ì›`);\r\n\r\n    // *** ìˆ˜ì •: ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì •ë³´ì™€ í•¨ê»˜ ê²°ê³¼ ë°˜í™˜\r\n    return {\r\n      count: successCount,\r\n      totalProcessed,\r\n      updatedUsers,\r\n    };\r\n  } catch (batchError) {\r\n    console.error('[database.js] batch commit ì˜¤ë¥˜:', batchError);\r\n    throw batchError;\r\n  }\r\n};\r\n\r\n\r\n/**\r\n * Initialize the database with default values\r\n */\r\nexport const initializeDatabase = async () => {\r\n  console.log(\"Initializing database...\");\r\n\r\n  if (!localStorage.getItem(\"dbInitialized\")) {\r\n    console.log(\"First time initialization...\");\r\n\r\n    // Initialize items\r\n    const defaultItems = [\r\n      {\r\n        id: 1,\r\n        name: \"ì—°í•„\",\r\n        description: \"ê³¼ì œ ì œì¶œ ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ë³¸ ì•„ì´í…œ\",\r\n        icon: \"âœï¸\",\r\n        price: 100,\r\n        effect: \"ê³¼ì œ ì œì¶œ ì‹œ ì‚¬ìš©\",\r\n        available: true,\r\n      },\r\n      {\r\n        id: 2,\r\n        name: \"ì§€ìš°ê°œ\",\r\n        description: \"ì‹¤ìˆ˜ë¥¼ ì§€ìš¸ ìˆ˜ ìˆëŠ” í•„ìˆ˜ ì•„ì´í…œ\",\r\n        icon: \"ğŸ§½\",\r\n        price: 50,\r\n        effect: \"ì‹¤ìˆ˜ í•˜ë‚˜ ì§€ìš°ê¸°\",\r\n        available: true,\r\n      },\r\n      {\r\n        id: 3,\r\n        name: \"ë…¸íŠ¸\",\r\n        description: \"í•™ìŠµ ë‚´ìš©ì„ ê¸°ë¡í•  ìˆ˜ ìˆëŠ” ì•„ì´í…œ\",\r\n        icon: \"ğŸ““\",\r\n        price: 200,\r\n        effect: \"í•™ìŠµ ê¸°ë¡\",\r\n        available: true,\r\n      },\r\n      {\r\n        id: 4,\r\n        name: \"ê³„ì‚°ê¸°\",\r\n        description: \"ë³µì¡í•œ ê³„ì‚°ì„ ë„ì™€ì£¼ëŠ” ì•„ì´í…œ\",\r\n        icon: \"ğŸ§®\",\r\n        price: 500,\r\n        effect: \"ê³„ì‚° ë„ì›€\",\r\n        available: true,\r\n      },\r\n      {\r\n        id: 5,\r\n        name: \"ê³ ê¸‰ íœ\",\r\n        description: \"ê³¼ì œ ì œì¶œ ì‹œ ì¶”ê°€ ì ìˆ˜ë¥¼ ì–»ì„ ìˆ˜ ìˆëŠ” ì•„ì´í…œ\",\r\n        icon: \"ğŸ–‹ï¸\",\r\n        price: 1000,\r\n        effect: \"ê³¼ì œ ì œì¶œ ì‹œ ì¶”ê°€ ì ìˆ˜\",\r\n        available: true,\r\n      },\r\n    ];\r\n\r\n    localStorage.setItem(\"items\", JSON.stringify(defaultItems));\r\n\r\n    // Initialize tasks\r\n    const defaultTasks = [\r\n      {\r\n        id: 1,\r\n        title: \"ê¸°ë³¸ ê²½ì œ ê°œë… í•™ìŠµ\",\r\n        description: \"ê¸°ë³¸ì ì¸ ê²½ì œ ìš©ì–´ì™€ ê°œë…ì„ í•™ìŠµí•˜ì„¸ìš”.\",\r\n        reward: 100,\r\n        couponReward: 1,\r\n        completed: false,\r\n        deadline: addDays(new Date(), 3),\r\n      },\r\n      {\r\n        id: 2,\r\n        title: \"ì˜ˆì‚° ê³„íš ì„¸ìš°ê¸°\",\r\n        description: \"í•œ ë‹¬ ì˜ˆì‚° ê³„íšì„ ì„¸ì›Œë³´ì„¸ìš”.\",\r\n        reward: 200,\r\n        couponReward: 2,\r\n        completed: false,\r\n        deadline: addDays(new Date(), 5),\r\n      },\r\n      {\r\n        id: 3,\r\n        title: \"ì €ì¶• ëª©í‘œ ì„¤ì •\",\r\n        description: \"ì €ì¶• ëª©í‘œì™€ ì „ëµì„ ìˆ˜ë¦½í•˜ì„¸ìš”.\",\r\n        reward: 150,\r\n        couponReward: 1,\r\n        completed: false,\r\n        deadline: addDays(new Date(), 7),\r\n      },\r\n    ];\r\n\r\n    localStorage.setItem(\"tasks\", JSON.stringify(defaultTasks));\r\n\r\n    // Initialize transactions\r\n    const defaultTransactions = [\r\n      {\r\n        id: 1,\r\n        date: new Date().toISOString(),\r\n        type: \"income\",\r\n        amount: 1000,\r\n        description: \"ì´ˆê¸° ì§€ê¸‰ê¸ˆ\",\r\n        category: \"system\",\r\n      },\r\n    ];\r\n\r\n    localStorage.setItem(\"transactions\", JSON.stringify(defaultTransactions));\r\n    localStorage.setItem(\"activity_logs\", JSON.stringify([]));\r\n    localStorage.setItem(\"dbInitialized\", \"true\");\r\n\r\n    console.log(\"Database initialization complete.\");\r\n  } else {\r\n    console.log(\"Database already initialized.\");\r\n  }\r\n};\r\n\r\n/**\r\n * Helper function to add days to a date\r\n */\r\nfunction addDays(date, days) {\r\n  const result = new Date(date);\r\n  result.setDate(result.getDate() + days);\r\n  return result.toISOString();\r\n}\r\n\r\n/**\r\n * í˜„ê¸ˆ ì „ì†¡ (ì†¡ê¸ˆ) - ìƒì„¸í•œ ë¡œê¹… í¬í•¨\r\n * @param {string} senderId - ì†¡ê¸ˆì ID\r\n * @param {string} receiverId - ìˆ˜ì‹ ì ID\r\n * @param {number} amount - ì†¡ê¸ˆì•¡\r\n * @param {string} message - ì†¡ê¸ˆ ë©”ì‹œì§€\r\n */\r\nexport const transferCash = async (senderId, receiverId, amount, message = '') => {\r\n  if (!senderId || !receiverId || amount <= 0) {\r\n    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì†¡ê¸ˆ ì •ë³´ì…ë‹ˆë‹¤.');\r\n  }\r\n\r\n  try {\r\n    // ì†¡ê¸ˆì ì”ì•¡ í™•ì¸\r\n    const senderDoc = await getUserDocument(senderId);\r\n    if (!senderDoc || (senderDoc.cash || 0) < amount) {\r\n      throw new Error('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');\r\n    }\r\n\r\n    const receiverDoc = await getUserDocument(receiverId);\r\n    if (!receiverDoc) {\r\n      throw new Error('ìˆ˜ì‹ ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\r\n    }\r\n\r\n    // ê±°ë˜ì„¸ ê³„ì‚° ë° ì ìš©\r\n    const classCode = senderDoc.classCode || receiverDoc.classCode;\r\n    const taxResult = await applyTransactionTax(classCode, senderId, amount, 'ì†¡ê¸ˆ');\r\n    const { taxAmount, netAmount } = taxResult;\r\n\r\n    // ì†¡ê¸ˆìëŠ” ì›ë˜ ê¸ˆì•¡ + ì„¸ê¸ˆì„ ì§€ë¶ˆí•´ì•¼ í•¨\r\n    const totalDeduction = amount + taxAmount;\r\n    if ((senderDoc.cash || 0) < totalDeduction) {\r\n      throw new Error(`ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ì†¡ê¸ˆì•¡: ${amount}ì› + ê±°ë˜ì„¸: ${taxAmount}ì› = ì´ ${totalDeduction}ì› í•„ìš”)`);\r\n    }\r\n\r\n    // ì†¡ê¸ˆ ì²˜ë¦¬\r\n    const transferMessage = message || `${senderDoc.name}ë‹˜ìœ¼ë¡œë¶€í„° ì†¡ê¸ˆ`;\r\n\r\n    // ì†¡ê¸ˆì ì°¨ê° (ì›ë˜ ê¸ˆì•¡ + ê±°ë˜ì„¸)\r\n    await updateUserCashInFirestore(senderId, -totalDeduction,\r\n      `${receiverDoc.name}ë‹˜ì—ê²Œ ${amount}ì› ì†¡ê¸ˆ (ê±°ë˜ì„¸ ${taxAmount}ì› í¬í•¨) ${message ? `(${message})` : ''}`);\r\n\r\n    await logActivity(senderId, LOG_TYPES.CASH_TRANSFER_SEND,\r\n      `${receiverDoc.name}ë‹˜ì—ê²Œ ${amount}ì›ì„ ì†¡ê¸ˆí–ˆìŠµë‹ˆë‹¤.${taxAmount > 0 ? ` (ê±°ë˜ì„¸ ${taxAmount}ì› ë‚©ë¶€)` : ''}${message ? ` ë©”ì‹œì§€: \"${message}\"` : ''}`,\r\n      {\r\n        receiverId,\r\n        receiverName: receiverDoc.name,\r\n        amount,\r\n        taxAmount,\r\n        totalDeduction,\r\n        message,\r\n        transactionType: 'transfer_send'\r\n      }\r\n    );\r\n\r\n    // ìˆ˜ì‹ ì ì¦ê°€ (ì„¸ê¸ˆ ì œì™¸í•œ ì›ë˜ ê¸ˆì•¡)\r\n    await updateUserCashInFirestore(receiverId, amount,\r\n      `${senderDoc.name}ë‹˜ìœ¼ë¡œë¶€í„° ${amount}ì› ì†¡ê¸ˆ ë°›ìŒ ${message ? `(${message})` : ''}`);\r\n\r\n    await logActivity(receiverId, LOG_TYPES.CASH_TRANSFER_RECEIVE,\r\n      `${senderDoc.name}ë‹˜ìœ¼ë¡œë¶€í„° ${amount}ì›ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.${message ? ` ë©”ì‹œì§€: \"${message}\"` : ''}`,\r\n      {\r\n        senderId,\r\n        senderName: senderDoc.name,\r\n        amount,\r\n        taxAmount,\r\n        message,\r\n        transactionType: 'transfer_receive'\r\n      }\r\n    );\r\n\r\n    return {\r\n      success: true,\r\n      amount,\r\n      taxAmount,\r\n      totalDeduction,\r\n      message: taxAmount > 0 ? `ì†¡ê¸ˆ ì™„ë£Œ. ê±°ë˜ì„¸ ${taxAmount}ì›ì´ ë¶€ê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.` : 'ì†¡ê¸ˆ ì™„ë£Œ.'\r\n    };\r\n  } catch (error) {\r\n    console.error('í˜„ê¸ˆ ì „ì†¡ ì‹¤íŒ¨:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * ì¿ í° ì „ì†¡ - ìƒì„¸í•œ ë¡œê¹… í¬í•¨\r\n * @param {string} senderId - ì†¡ê¸ˆì ID\r\n * @param {string} receiverId - ìˆ˜ì‹ ì ID\r\n * @param {number} amount - ì¿ í° ìˆ˜ëŸ‰\r\n * @param {string} message - ì „ì†¡ ë©”ì‹œì§€\r\n */\r\nexport const transferCoupons = async (senderId, receiverId, amount, message = '') => {\r\n  if (!senderId || !receiverId || amount <= 0) {\r\n    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì¿ í° ì „ì†¡ ì •ë³´ì…ë‹ˆë‹¤.');\r\n  }\r\n\r\n  try {\r\n    // ì†¡ê¸ˆì ì¿ í° í™•ì¸\r\n    const senderDoc = await getUserDocument(senderId);\r\n    if (!senderDoc || (senderDoc.coupons || 0) < amount) {\r\n      throw new Error('ì¿ í°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');\r\n    }\r\n\r\n    const receiverDoc = await getUserDocument(receiverId);\r\n    if (!receiverDoc) {\r\n      throw new Error('ìˆ˜ì‹ ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\r\n    }\r\n\r\n    // ì¿ í° ì „ì†¡ì˜ ê²½ìš° í˜„ê¸ˆ ê¸°ì¤€ ê°€ê²©ìœ¼ë¡œ ê±°ë˜ì„¸ ê³„ì‚° (ì¿ í° 1ê°œ = 100ì›ìœ¼ë¡œ ê°€ì •)\r\n    const classCode = senderDoc.classCode || receiverDoc.classCode;\r\n    const couponValue = amount * 100; // ì¿ í° 1ê°œë‹¹ 100ì›ìœ¼ë¡œ ê³„ì‚°\r\n    const taxResult = await applyTransactionTax(classCode, senderId, couponValue, 'ì¿ í° ì „ì†¡');\r\n    const { taxAmount } = taxResult;\r\n\r\n    // ì†¡ê¸ˆìëŠ” ê±°ë˜ì„¸ë¥¼ í˜„ê¸ˆìœ¼ë¡œ ì§€ë¶ˆí•´ì•¼ í•¨\r\n    if (taxAmount > 0 && (senderDoc.cash || 0) < taxAmount) {\r\n      throw new Error(`ê±°ë˜ì„¸ ë‚©ë¶€ë¥¼ ìœ„í•œ í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ê±°ë˜ì„¸: ${taxAmount}ì› í•„ìš”)`);\r\n    }\r\n\r\n    // ì¿ í° ì „ì†¡ ì²˜ë¦¬\r\n    const transferMessage = message || `${senderDoc.name}ë‹˜ìœ¼ë¡œë¶€í„° ì¿ í° ìˆ˜ì‹ `;\r\n\r\n    // ì†¡ê¸ˆì ì¿ í° ì°¨ê°\r\n    await updateUserCouponsInFirestore(senderId, -amount,\r\n      `${receiverDoc.name}ë‹˜ì—ê²Œ ì¿ í° ${amount}ê°œ ì „ì†¡ ${message ? `(${message})` : ''}`\r\n    );\r\n\r\n    // ê±°ë˜ì„¸ ì°¨ê° (í˜„ê¸ˆìœ¼ë¡œ)\r\n    if (taxAmount > 0) {\r\n      await updateUserCashInFirestore(senderId, -taxAmount, `ì¿ í° ì „ì†¡ ê±°ë˜ì„¸ ${taxAmount}ì›`);\r\n    }\r\n\r\n    await logActivity(senderId, LOG_TYPES.COUPON_TRANSFER_SEND,\r\n      `${receiverDoc.name}ë‹˜ì—ê²Œ ì¿ í° ${amount}ê°œë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.${taxAmount > 0 ? ` (ê±°ë˜ì„¸ ${taxAmount}ì› ë‚©ë¶€)` : ''}${message ? ` ë©”ì‹œì§€: \"${message}\"` : ''}`,\r\n      {\r\n        receiverId,\r\n        receiverName: receiverDoc.name,\r\n        amount,\r\n        taxAmount,\r\n        couponValue,\r\n        message,\r\n        transactionType: 'coupon_transfer_send'\r\n      }\r\n    );\r\n\r\n    // ìˆ˜ì‹ ì ì¦ê°€\r\n    await updateUserCouponsInFirestore(receiverId, amount,\r\n      `${senderDoc.name}ë‹˜ìœ¼ë¡œë¶€í„° ì¿ í° ${amount}ê°œ ë°›ìŒ ${message ? `(${message})` : ''}`);\r\n\r\n    await logActivity(receiverId, LOG_TYPES.COUPON_TRANSFER_RECEIVE,\r\n      `${senderDoc.name}ë‹˜ìœ¼ë¡œë¶€í„° ì¿ í° ${amount}ê°œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.${message ? ` ë©”ì‹œì§€: \"${message}\"` : ''}`,\r\n      {\r\n        senderId,\r\n        senderName: senderDoc.name,\r\n        amount,\r\n        taxAmount,\r\n        message,\r\n        transactionType: 'coupon_transfer_receive'\r\n      }\r\n    );\r\n\r\n    return {\r\n      success: true,\r\n      amount,\r\n      taxAmount,\r\n      message: taxAmount > 0 ? `ì¿ í° ì „ì†¡ ì™„ë£Œ. ê±°ë˜ì„¸ ${taxAmount}ì›ì´ ë¶€ê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.` : 'ì¿ í° ì „ì†¡ ì™„ë£Œ.'\r\n    };\r\n  } catch (error) {\r\n    console.error('ì¿ í° ì „ì†¡ ì‹¤íŒ¨:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * ê±°ë˜ ì¶”ê°€ (ê°œì„ ëœ ë²„ì „) - ìƒì„¸í•œ ë¡œê¹… í¬í•¨\r\n */\r\nexport const addTransaction = async (transaction, updateFirebase = true) => {\r\n  try {\r\n    // localStorageì— ê±°ë˜ ê¸°ë¡\r\n    const transactionsJson = localStorage.getItem(\"transactions\");\r\n    const transactions = transactionsJson ? JSON.parse(transactionsJson) : [];\r\n\r\n    const newTransaction = {\r\n      ...transaction,\r\n      id: transactions.length > 0\r\n        ? Math.max(...transactions.map((t) => t.id)) + 1\r\n        : 1,\r\n      date: new Date().toISOString(),\r\n    };\r\n\r\n    transactions.push(newTransaction);\r\n    localStorage.setItem(\"transactions\", JSON.stringify(transactions));\r\n\r\n    // Firebase ì—…ë°ì´íŠ¸\r\n    if (updateFirebase && transaction.userId && typeof transaction.amount === 'number') {\r\n      try {\r\n        const logType = transaction.type === 'income' ? LOG_TYPES.CASH_INCOME : LOG_TYPES.CASH_EXPENSE;\r\n        const logMessage = `${transaction.description} (${Math.abs(transaction.amount)}ì›)`;\r\n\r\n        if (transaction.type === 'income') {\r\n          await updateUserCashInFirestore(transaction.userId, transaction.amount, logMessage);\r\n        } else if (transaction.type === 'expense') {\r\n          await updateUserCashInFirestore(transaction.userId, -Math.abs(transaction.amount), logMessage);\r\n        }\r\n\r\n        await logActivity(transaction.userId, logType, logMessage, {\r\n          amount: transaction.amount,\r\n          category: transaction.category,\r\n          transactionId: newTransaction.id,\r\n          transactionType: transaction.type\r\n        });\r\n\r\n        // Firebaseì—ë„ ê±°ë˜ ê¸°ë¡ ì €ì¥\r\n        if (firebaseAddTransaction) {\r\n          await firebaseAddTransaction(transaction.userId, transaction.amount, transaction.description);\r\n        }\r\n\r\n        console.log('[DB] Firebase ë™ê¸°í™” ì™„ë£Œ:', newTransaction);\r\n      } catch (firebaseError) {\r\n        console.error('[DB] Firebase ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜:', firebaseError);\r\n      }\r\n    }\r\n\r\n    return newTransaction;\r\n  } catch (error) {\r\n    console.error(\"Error adding transaction:\", error);\r\n    return null;\r\n  }\r\n};\r\n\r\n/**\r\n * ì‚¬ìš©ì ê±°ë˜ ë‚´ì—­ ì¡°íšŒ\r\n */\r\nexport const getUserTransactions = (userId, limit = null) => {\r\n  try {\r\n    const transactionsJson = localStorage.getItem(\"transactions\");\r\n    const transactions = transactionsJson ? JSON.parse(transactionsJson) : [];\r\n\r\n    let filteredTransactions = transactions;\r\n    if (userId) {\r\n      filteredTransactions = transactions.filter(t => t.userId === userId);\r\n    }\r\n\r\n    const sortedTransactions = filteredTransactions.sort(\r\n      (a, b) => new Date(b.date) - new Date(a.date)\r\n    );\r\n\r\n    if (limit && limit > 0) {\r\n      return sortedTransactions.slice(0, limit);\r\n    }\r\n\r\n    return sortedTransactions;\r\n  } catch (error) {\r\n    console.error(\"Error getting transactions:\", error);\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * ì‚¬ìš©ì ê³¼ì œ ì¡°íšŒ\r\n */\r\nexport const getUserTasks = (userId, completed = null) => {\r\n  try {\r\n    const tasksJson = localStorage.getItem(\"tasks\");\r\n    const tasks = tasksJson ? JSON.parse(tasksJson) : [];\r\n\r\n    if (completed !== null) {\r\n      return tasks.filter((task) => task.completed === completed);\r\n    }\r\n\r\n    return tasks;\r\n  } catch (error) {\r\n    console.error(\"Error getting tasks:\", error);\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * ê³¼ì œ ì™„ë£Œ (ê°œì„ ëœ ë²„ì „) - ìƒì„¸í•œ ë¡œê¹… í¬í•¨\r\n */\r\nexport const completeTask = async (taskId, userId, updateFirebase = true) => {\r\n  try {\r\n    const tasksJson = localStorage.getItem(\"tasks\");\r\n    const tasks = tasksJson ? JSON.parse(tasksJson) : [];\r\n\r\n    const taskIndex = tasks.findIndex((task) => task.id === taskId);\r\n    if (taskIndex === -1) {\r\n      console.warn(`Task with ID ${taskId} not found`);\r\n      return false;\r\n    }\r\n\r\n    const completedTask = tasks[taskIndex];\r\n    tasks[taskIndex].completed = true;\r\n    localStorage.setItem(\"tasks\", JSON.stringify(tasks));\r\n\r\n    const cashReward = completedTask.reward || 0;\r\n    const couponReward = completedTask.couponReward || 0;\r\n\r\n    if (updateFirebase && userId) {\r\n      try {\r\n        // í˜„ê¸ˆ ë³´ìƒ (ì†Œë“ì„¸ ì ìš©)\r\n        if (cashReward > 0) {\r\n          const userDoc = await getUserDocument(userId);\r\n          const classCode = userDoc?.classCode;\r\n\r\n          if (classCode) {\r\n            const taxResult = await applyIncomeTax(classCode, userId, cashReward, 'reward');\r\n            const { netIncome, taxAmount } = taxResult;\r\n\r\n            await updateUserCashInFirestore(userId, netIncome,\r\n              `'${completedTask.title}' ê³¼ì œ ì™„ë£Œ ë³´ìƒ (ì„¸í›„ ${netIncome}ì›, ì†Œë“ì„¸ ${taxAmount}ì› ë‚©ë¶€)`\r\n            );\r\n          } else {\r\n            await updateUserCashInFirestore(userId, cashReward,\r\n              `'${completedTask.title}' ê³¼ì œ ì™„ë£Œ ë³´ìƒ`\r\n            );\r\n          }\r\n        }\r\n\r\n        // ì¿ í° ë³´ìƒ\r\n        if (couponReward > 0) {\r\n          await updateUserCouponsInFirestore(userId, couponReward,\r\n            `'${completedTask.title}' ê³¼ì œ ì™„ë£Œ ì¿ í° ë³´ìƒ`\r\n          );\r\n\r\n          // ì¿ í° íšë“ì— ëŒ€í•œ ë³„ë„ ë¡œê·¸ (ìˆ˜ì •ëœ ë¶€ë¶„)\r\n          await logActivity(userId, LOG_TYPES.COUPON_EARN,\r\n            `'ê³¼ì œ ì™„ë£Œ: ${completedTask.title}' í™œë™ìœ¼ë¡œ ì¿ í° ${couponReward}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`,\r\n            {\r\n              taskId,\r\n              taskTitle: completedTask.title,\r\n              couponAmount: couponReward,\r\n              reason: 'task_completion',\r\n              activity: `ê³¼ì œ ì™„ë£Œ: ${completedTask.title}`, // ì–´ë–¤ í™œë™ì¸ì§€ ëª…ì‹œ\r\n              taskDescription: completedTask.description\r\n            }\r\n          );\r\n        }\r\n\r\n        // ê³¼ì œ ì™„ë£Œ í™œë™ ë¡œê·¸\r\n        const rewardText = [];\r\n        if (cashReward > 0) rewardText.push(`í˜„ê¸ˆ ${cashReward}ì›`);\r\n        if (couponReward > 0) rewardText.push(`ì¿ í° ${couponReward}ê°œ`);\r\n\r\n        await logActivity(userId, LOG_TYPES.TASK_COMPLETE,\r\n          `'${completedTask.title}' ê³¼ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.${rewardText.length > 0 ? ` ë³´ìƒ: ${rewardText.join(', ')}` : ''}`,\r\n          {\r\n            taskId,\r\n            taskTitle: completedTask.title,\r\n            taskDescription: completedTask.description,\r\n            cashReward,\r\n            couponReward,\r\n            deadline: completedTask.deadline\r\n          }\r\n        );\r\n\r\n        console.log(`[DB] ê³¼ì œ ì™„ë£Œ Firebase ë™ê¸°í™” ì™„ë£Œ: ${completedTask.title}`);\r\n      } catch (firebaseError) {\r\n        console.error('[DB] Firebase ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜:', firebaseError);\r\n      }\r\n    }\r\n\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error completing task:\", error);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * ì•„ì´í…œ ì‚¬ìš© ê¸°ë¡ - ìƒì„¸í•œ ë¡œê¹… í¬í•¨\r\n */\r\nexport const useItem = async (userId, itemName, effect, quantity = 1, context = '') => {\r\n  if (!userId || !itemName) {\r\n    console.warn('[DB] useItem: userIdì™€ itemNameì´ í•„ìš”í•©ë‹ˆë‹¤.');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const contextText = context ? ` (${context})` : '';\r\n    await logActivity(userId, LOG_TYPES.ITEM_USE,\r\n      `${itemName} ${quantity}ê°œë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.${contextText} íš¨ê³¼: ${effect}`,\r\n      {\r\n        itemName,\r\n        effect,\r\n        quantity,\r\n        context,\r\n        usageTime: new Date().toISOString()\r\n      }\r\n    );\r\n    console.log(`[DB] ì•„ì´í…œ ì‚¬ìš© ê¸°ë¡ ì™„ë£Œ: ${itemName}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('[DB] ì•„ì´í…œ ì‚¬ìš© ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * ì•„ì´í…œ íšë“ ê¸°ë¡ - ìƒˆë¡œìš´ í•¨ìˆ˜ ì¶”ê°€\r\n */\r\nexport const obtainItem = async (userId, itemName, quantity = 1, source = 'unknown') => {\r\n  if (!userId || !itemName) {\r\n    console.warn('[DB] obtainItem: userIdì™€ itemNameì´ í•„ìš”í•©ë‹ˆë‹¤.');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const sourceText = source !== 'unknown' ? ` (${source})` : '';\r\n    await logActivity(userId, LOG_TYPES.ITEM_OBTAIN,\r\n      `${itemName} ${quantity}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.${sourceText}`,\r\n      {\r\n        itemName,\r\n        quantity,\r\n        source,\r\n        obtainTime: new Date().toISOString()\r\n      }\r\n    );\r\n    console.log(`[DB] ì•„ì´í…œ íšë“ ê¸°ë¡ ì™„ë£Œ: ${itemName}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('[DB] ì•„ì´í…œ íšë“ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * ê²Œì„ ê²°ê³¼ ê¸°ë¡ - ìƒì„¸í•œ ë¡œê¹… í¬í•¨\r\n */\r\nexport const recordGameResult = async (userId, gameName, result, reward = null, gameDetails = {}) => {\r\n  if (!userId || !gameName || !result) {\r\n    console.warn('[DB] recordGameResult: ëª¨ë“  ë§¤ê°œë³€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const logType = result === 'win' ? LOG_TYPES.GAME_WIN :\r\n                   result === 'lose' ? LOG_TYPES.GAME_LOSE :\r\n                   LOG_TYPES.GAME_REWARD;\r\n\r\n    let description = `${gameName}ì—ì„œ ${result === 'win' ? 'ìŠ¹ë¦¬' : result === 'lose' ? 'íŒ¨ë°°' : 'ê²Œì„ ì™„ë£Œ'}í–ˆìŠµë‹ˆë‹¤.`;\r\n    const rewardDetails = [];\r\n\r\n    if (reward) {\r\n      if (reward.cash > 0) {\r\n        await updateUserCashInFirestore(userId, reward.cash, `${gameName} ë³´ìƒ`);\r\n        rewardDetails.push(`í˜„ê¸ˆ ${reward.cash}ì›`);\r\n      }\r\n      if (reward.coupons > 0) {\r\n        await updateUserCouponsInFirestore(userId, reward.coupons, `${gameName} ë³´ìƒ`);\r\n        rewardDetails.push(`ì¿ í° ${reward.coupons}ê°œ`);\r\n\r\n        // ì¿ í° íšë“ì— ëŒ€í•œ ë³„ë„ ë¡œê·¸ (ìˆ˜ì •ëœ ë¶€ë¶„)\r\n        await logActivity(userId, LOG_TYPES.COUPON_EARN,\r\n          `'ê²Œì„ ë³´ìƒ: ${gameName}' í™œë™ìœ¼ë¡œ ì¿ í° ${reward.coupons}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`,\r\n          {\r\n            gameName,\r\n            result,\r\n            couponAmount: reward.coupons,\r\n            reason: 'game_reward',\r\n            activity: `ê²Œì„ ë³´ìƒ: ${gameName}`, // ì–´ë–¤ í™œë™ì¸ì§€ ëª…ì‹œ\r\n            gameDetails\r\n          }\r\n        );\r\n      }\r\n\r\n      if (rewardDetails.length > 0) {\r\n        description += ` ë³´ìƒ: ${rewardDetails.join(', ')}`;\r\n      }\r\n    }\r\n\r\n    await logActivity(userId, logType, description, {\r\n      gameName,\r\n      result,\r\n      reward,\r\n      gameDetails,\r\n      duration: gameDetails.duration || null,\r\n      score: gameDetails.score || null\r\n    });\r\n\r\n    console.log(`[DB] ê²Œì„ ê²°ê³¼ ê¸°ë¡ ì™„ë£Œ: ${gameName} - ${result}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('[DB] ê²Œì„ ê²°ê³¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n\r\n/**\r\n * ê´€ë¦¬ì ì•¡ì…˜ ê¸°ë¡\r\n */\r\nexport const recordAdminAction = async (adminId, action, targetUserId, details) => {\r\n  if (!adminId || !action || !targetUserId) {\r\n    console.warn('[DB] recordAdminAction: í•„ìˆ˜ ë§¤ê°œë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    await logActivity(adminId, LOG_TYPES.ADMIN_ACTION,\r\n      `ê´€ë¦¬ìê°€ ${action} ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. ëŒ€ìƒ: ${targetUserId}`,\r\n      { action, targetUserId, details }\r\n    );\r\n    console.log(`[DB] ê´€ë¦¬ì ì•¡ì…˜ ê¸°ë¡ ì™„ë£Œ: ${action}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('[DB] ê´€ë¦¬ì ì•¡ì…˜ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * ê¸‰ì—¬ ì§€ê¸‰ ê¸°ë¡\r\n */\r\nexport const recordSalaryPayment = async (userId, amount, period, details = {}) => {\r\n  if (!userId || !amount || amount <= 0) {\r\n    console.warn('[DB] recordSalaryPayment: í•„ìˆ˜ ë§¤ê°œë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const userDoc = await getUserDocument(userId);\r\n    const classCode = userDoc?.classCode;\r\n\r\n    if (classCode) {\r\n      // ê¸‰ì—¬ì— ì†Œë“ì„¸ ì ìš©\r\n      const taxResult = await applyIncomeTax(classCode, userId, amount, 'salary');\r\n      const { netIncome, taxAmount } = taxResult;\r\n\r\n      await updateUserCashInFirestore(userId, netIncome,\r\n        `${period} ê¸‰ì—¬ ì§€ê¸‰ (ì„¸í›„ ${netIncome}ì›, ì†Œë“ì„¸ ${taxAmount}ì› ë‚©ë¶€)`\r\n      );\r\n\r\n      await logActivity(userId, LOG_TYPES.SALARY_PAYMENT,\r\n        `${period} ê¸‰ì—¬ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${amount}ì›, ì„¸í›„ ${netIncome}ì›, ì†Œë“ì„¸ ${taxAmount}ì›)`,\r\n        {\r\n          grossAmount: amount,\r\n          netAmount: netIncome,\r\n          taxAmount,\r\n          period,\r\n          details,\r\n          paymentDate: new Date().toISOString()\r\n        }\r\n      );\r\n\r\n      console.log(`[DB] ê¸‰ì—¬ ì§€ê¸‰ ê¸°ë¡ ì™„ë£Œ: ${userId} - ì´ ${amount}ì› (ì„¸í›„ ${netIncome}ì›)`);\r\n    } else {\r\n      // í´ë˜ìŠ¤ ì½”ë“œê°€ ì—†ëŠ” ê²½ìš° ê¸°ì¡´ ë°©ì‹\r\n      await updateUserCashInFirestore(userId, amount, `${period} ê¸‰ì—¬ ì§€ê¸‰`);\r\n      await logActivity(userId, LOG_TYPES.SALARY_PAYMENT,\r\n        `${period} ê¸‰ì—¬ ${amount}ì›ì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.`,\r\n        {\r\n          amount,\r\n          period,\r\n          details,\r\n          paymentDate: new Date().toISOString()\r\n        }\r\n      );\r\n      console.log(`[DB] ê¸‰ì—¬ ì§€ê¸‰ ê¸°ë¡ ì™„ë£Œ: ${userId} - ${amount}ì›`);\r\n    }\r\n\r\n    return true;\r\n  } catch (error) {\r\n    console.error('[DB] ê¸‰ì—¬ ì§€ê¸‰ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * ì¿ í° ê´€ë ¨ ê´€ë¦¬ì ì•¡ì…˜\r\n */\r\nexport const adminCouponAction = async (adminId, targetUserId, action, amount, reason) => {\r\n  if (!adminId || !targetUserId || !action || !amount) {\r\n    console.warn('[DB] adminCouponAction: í•„ìˆ˜ ë§¤ê°œë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const isGive = action === 'give';\r\n    const logType = isGive ? LOG_TYPES.COUPON_GIVE : LOG_TYPES.COUPON_TAKE;\r\n    const actionAmount = isGive ? amount : -Math.abs(amount);\r\n\r\n    await updateUserCouponsInFirestore(targetUserId, actionAmount,\r\n      `ê´€ë¦¬ì ${isGive ? 'ì§€ê¸‰' : 'íšŒìˆ˜'}: ${reason || 'ê´€ë¦¬ì ì¡°ì¹˜'}`\r\n    );\r\n\r\n    const targetDoc = await getUserDocument(targetUserId);\r\n    const targetName = targetDoc?.name || 'ì‚¬ìš©ì';\r\n\r\n    await logActivity(targetUserId, logType,\r\n      `ê´€ë¦¬ìê°€ ì¿ í° ${Math.abs(amount)}ê°œë¥¼ ${isGive ? 'ì§€ê¸‰' : 'íšŒìˆ˜'}í–ˆìŠµë‹ˆë‹¤.${reason ? ` ì‚¬ìœ : ${reason}` : ''}`,\r\n      {\r\n        adminId,\r\n        action,\r\n        amount: Math.abs(amount),\r\n        reason,\r\n        targetUserId,\r\n        targetName\r\n      }\r\n    );\r\n\r\n    // ê´€ë¦¬ì ì•¡ì…˜ë„ ë³„ë„ ê¸°ë¡\r\n    await recordAdminAction(adminId, `ì¿ í° ${isGive ? 'ì§€ê¸‰' : 'íšŒìˆ˜'}`, targetUserId, {\r\n      amount: Math.abs(amount),\r\n      reason\r\n    });\r\n\r\n    console.log(`[DB] ê´€ë¦¬ì ì¿ í° ì•¡ì…˜ ì™„ë£Œ: ${action} - ${amount}ê°œ`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('[DB] ê´€ë¦¬ì ì¿ í° ì•¡ì…˜ ì¤‘ ì˜¤ë¥˜:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Export log types for external use\r\nexport { LOG_TYPES, logActivity };"],"names":["LOG_TYPES","CASH_INCOME","CASH_EXPENSE","CASH_TRANSFER_SEND","CASH_TRANSFER_RECEIVE","ADMIN_CASH_SEND","ADMIN_CASH_TAKE","COUPON_EARN","COUPON_USE","COUPON_GIVE","COUPON_TAKE","COUPON_TRANSFER_SEND","COUPON_TRANSFER_RECEIVE","ITEM_PURCHASE","ITEM_USE","ITEM_SELL","ITEM_MARKET_LIST","ITEM_MARKET_BUY","ITEM_OBTAIN","ITEM_MOVE","TASK_COMPLETE","TASK_REWARD","GAME_WIN","GAME_LOSE","GAME_REWARD","OMOK_GAME","CHESS_GAME","STOCK_BUY","STOCK_SELL","TAX_PAYMENT","TAX_REFUND","FINE_PAYMENT","SALARY_PAYMENT","BONUS_PAYMENT","SYSTEM","ADMIN_ACTION","TREASURY_DEPOSIT","TREASURY_WITHDRAW","logActivity","async","userId","type","description","metadata","arguments","length","undefined","addActivityLog","Object","keys","console","log","concat","error","adminCashAction","adminName","adminClassCode","targetUsers","action","takeMode","amountType","amount","taxRate","_ref","targetUsersCount","batch","writeBatch","db","totalProcessed","successCount","updatedUsers","user","currentCash","Number","cash","baseAmount","Math","floor","name","newCash","finalAmount","taxAmount","push","id","í˜„ì¬ì”ì•¡","ê¸°ë³¸ê¸ˆì•¡","ì„¸ê¸ˆ","ìµœì¢…ê¸ˆì•¡","ìƒˆì”ì•¡","userRef","doc","update","updatedAt","serverTimestamp","logRef","collection","logType","logDescription","toLocaleString","logData","userName","timestamp","classCode","inputValue","previousCash","set","transactionRef","transactionData","category","userError","commit","count","batchError"],"sourceRoot":""}