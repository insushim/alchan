{"version":3,"file":"static/js/3380.f8a6abae.chunk.js","mappings":"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","sources":["pages/student/StudentRequest.js","utils/youtube-api.js"],"sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport { useParams, useNavigate } from \"react-router-dom\";\nimport { db } from \"../../firebase\";\nimport {\n  doc,\n  getDoc,\n  collection,\n  addDoc,\n  serverTimestamp,\n  runTransaction,\n  increment,\n} from \"firebase/firestore\";\nimport { searchVideos } from \"../../utils/youtube-api\";\nimport { useAuth } from \"../../contexts/AuthContext\";\nimport { logger } from \"../../utils/logger\";\nimport \"./StudentRequest.css\";\n\nconst StudentRequest = () => {\n  const { roomId } = useParams();\n  const { user, userDoc } = useAuth();\n  const [roomName, setRoomName] = useState(\"\");\n  const [pricePerSong, setPricePerSong] = useState(0);\n  const [teacherId, setTeacherId] = useState(\"\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [videos, setVideos] = useState([]);\n  const [selectedVideo, setSelectedVideo] = useState(null);\n  const [requesterName, setRequesterName] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [isRequesting, setIsRequesting] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [requestSuccess, setRequestSuccess] = useState(false);\n  const navigate = useNavigate();\n\n  useEffect(() => {\n    const fetchRoomInfo = async () => {\n      const roomDoc = await getDoc(doc(db, \"musicRooms\", roomId));\n      if (roomDoc.exists()) {\n        const data = roomDoc.data();\n        setRoomName(data.name);\n        setPricePerSong(data.pricePerSong || 0);\n        setTeacherId(data.teacherId || \"\");\n      } else {\n        setError(\"존재하지 않는 방입니다.\");\n      }\n    };\n    fetchRoomInfo();\n  }, [roomId]);\n\n  // 로그인된 사용자의 이름 자동 채우기\n  useEffect(() => {\n    if (userDoc?.name) {\n      setRequesterName(userDoc.name);\n    }\n  }, [userDoc]);\n\n  const handleSearch = async (e) => {\n    e.preventDefault();\n    if (!searchTerm.trim()) return;\n    setIsLoading(true);\n    setError(\"\");\n    try {\n      const results = await searchVideos(searchTerm);\n      setVideos(results);\n      setRequestSuccess(false);\n    } catch (err) {\n      setError(\"YouTube 영상을 검색하는 중 오류가 발생했습니다.\");\n      logger.error(err);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleRequest = async () => {\n    if (!selectedVideo) {\n      alert(\"영상을 선택해주세요.\");\n      return;\n    }\n\n    const name = requesterName.trim();\n    if (!name) {\n      alert(\"신청자 이름을 입력해주세요.\");\n      return;\n    }\n\n    // 가격이 있으면 로그인 필수\n    if (pricePerSong > 0 && !user) {\n      alert(\"유료 음악 신청은 로그인이 필요합니다.\");\n      return;\n    }\n\n    setIsRequesting(true);\n    try {\n      // 결제 처리\n      if (pricePerSong > 0 && user && teacherId) {\n        const currentCash = userDoc?.cash || 0;\n        if (currentCash < pricePerSong) {\n          alert(\n            `잔액이 부족합니다. 필요: ${pricePerSong.toLocaleString()}, 보유: ${currentCash.toLocaleString()}`,\n          );\n          setIsRequesting(false);\n          return;\n        }\n\n        await runTransaction(db, async (transaction) => {\n          const studentRef = doc(db, \"users\", user.uid);\n          const teacherRef = doc(db, \"users\", teacherId);\n          const studentSnap = await transaction.get(studentRef);\n\n          if (!studentSnap.exists())\n            throw new Error(\"사용자 정보를 찾을 수 없습니다.\");\n          const cash = studentSnap.data().cash || 0;\n          if (cash < pricePerSong) throw new Error(\"잔액이 부족합니다.\");\n\n          transaction.update(studentRef, { cash: increment(-pricePerSong) });\n          transaction.update(teacherRef, { cash: increment(pricePerSong) });\n        });\n      }\n\n      // 플레이리스트에 추가\n      await addDoc(collection(db, \"musicRooms\", roomId, \"playlist\"), {\n        videoId: selectedVideo.id.videoId,\n        title: selectedVideo.snippet.title,\n        requesterName: name,\n        requestedAt: serverTimestamp(),\n        ...(user ? { requesterId: user.uid } : {}),\n        paidAmount: pricePerSong || 0,\n      });\n\n      setRequestSuccess(true);\n    } catch (err) {\n      if (err.message === \"잔액이 부족합니다.\") {\n        alert(\"잔액이 부족합니다.\");\n      } else {\n        setError(\"음악을 신청하는 중 오류가 발생했습니다.\");\n        logger.error(err);\n      }\n    } finally {\n      setIsRequesting(false);\n    }\n  };\n\n  const resetForNextRequest = () => {\n    setRequestSuccess(false);\n    setSelectedVideo(null);\n    setSearchTerm(\"\");\n    setVideos([]);\n  };\n\n  if (error && !videos.length) {\n    return (\n      <div className=\"student-request-container error-container\">{error}</div>\n    );\n  }\n\n  return (\n    <div className=\"student-request-container\">\n      <h2>{roomName || \"음악 신청\"}</h2>\n\n      {pricePerSong > 0 && (\n        <div className=\"price-info\">\n          1곡당 {pricePerSong.toLocaleString()} 알찬\n          {user && userDoc && (\n            <span> (보유: {(userDoc.cash || 0).toLocaleString()})</span>\n          )}\n        </div>\n      )}\n\n      {requestSuccess ? (\n        <div className=\"success-section\">\n          <h3>\"{selectedVideo.snippet.title}\"</h3>\n          <p>음악 신청이 완료되었습니다!</p>\n          {pricePerSong > 0 && (\n            <p style={{ color: \"#a5b4fc\", fontSize: \"0.9rem\" }}>\n              {pricePerSong.toLocaleString()} 알찬이 차감되었습니다.\n            </p>\n          )}\n          <div className=\"success-actions\">\n            <button\n              onClick={resetForNextRequest}\n              className=\"action-btn continue-btn\"\n            >\n              계속 신청하기\n            </button>\n            <button\n              onClick={() => navigate(\"/learning-board/music-request\")}\n              className=\"action-btn back-btn\"\n            >\n              돌아가기\n            </button>\n          </div>\n        </div>\n      ) : (\n        <>\n          <form onSubmit={handleSearch} className=\"search-form\">\n            <input\n              type=\"text\"\n              className=\"search-input\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"신청할 노래 제목이나 아티스트를 검색하세요\"\n            />\n            <button type=\"submit\" className=\"search-btn\" disabled={isLoading}>\n              {isLoading ? \"검색 중...\" : \"검색\"}\n            </button>\n          </form>\n\n          {error && (\n            <p style={{ color: \"#f87171\", marginBottom: \"1rem\" }}>{error}</p>\n          )}\n\n          {videos.length > 0 && (\n            <div className=\"search-results\">\n              <ul className=\"video-list\">\n                {videos.map((video) => (\n                  <li\n                    key={video.id.videoId}\n                    className={`video-item ${selectedVideo?.id.videoId === video.id.videoId ? \"selected\" : \"\"}`}\n                    onClick={() => setSelectedVideo(video)}\n                  >\n                    <img\n                      src={video.snippet.thumbnails.default.url}\n                      alt={video.snippet.title}\n                      loading=\"lazy\"\n                      width=\"120\"\n                      height=\"90\"\n                    />\n                    <p>{video.snippet.title}</p>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n\n          {selectedVideo && (\n            <div className=\"request-section\">\n              <h4>신청 정보</h4>\n              <p>선택된 곡: {selectedVideo.snippet.title}</p>\n              {!user && (\n                <input\n                  type=\"text\"\n                  className=\"requester-name-input\"\n                  value={requesterName}\n                  onChange={(e) => setRequesterName(e.target.value)}\n                  placeholder=\"신청자 이름을 입력하세요\"\n                />\n              )}\n              <button\n                onClick={handleRequest}\n                className=\"request-btn\"\n                disabled={isRequesting}\n              >\n                {isRequesting\n                  ? \"신청 중...\"\n                  : pricePerSong > 0\n                    ? `${pricePerSong.toLocaleString()} 알찬으로 신청하기`\n                    : \"이 곡으로 신청하기\"}\n              </button>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n};\n\nexport default StudentRequest;\n","import { logger } from './logger';\r\nconst API_KEY = process.env.REACT_APP_YOUTUBE_API_KEY; // .env 파일에서 API 키를 불러옵니다.\r\n\r\nexport const searchVideos = async (query) => {\r\n    const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${API_KEY}&maxResults=10`);\r\n    \r\n    if (!response.ok) {\r\n        const errorData = await response.json();\r\n        logger.error(\"YouTube API Error:\", errorData);\r\n        throw new Error('YouTube 영상을 검색하는 데 실패했습니다. API 키나 요청을 확인해주세요.');\r\n    }\r\n    \r\n    const data = await response.json();\r\n    return data.items;\r\n};"],"names":["StudentRequest","roomId","useParams","user","userDoc","useAuth","roomName","setRoomName","useState","pricePerSong","setPricePerSong","teacherId","setTeacherId","searchTerm","setSearchTerm","videos","setVideos","selectedVideo","setSelectedVideo","requesterName","setRequesterName","isLoading","setIsLoading","isRequesting","setIsRequesting","error","setError","requestSuccess","setRequestSuccess","navigate","useNavigate","useEffect","async","roomDoc","getDoc","doc","db","exists","data","name","fetchRoomInfo","length","_jsx","className","children","_jsxs","toLocaleString","cash","snippet","title","style","color","fontSize","onClick","resetForNextRequest","_Fragment","onSubmit","e","preventDefault","trim","results","response","fetch","concat","encodeURIComponent","query","process","ok","errorData","json","logger","Error","items","searchVideos","err","type","value","onChange","target","placeholder","disabled","marginBottom","map","video","id","videoId","src","thumbnails","default","url","alt","loading","width","height","alert","currentCash","runTransaction","studentRef","uid","teacherRef","studentSnap","transaction","get","update","increment","addDoc","collection","_objectSpread","requestedAt","serverTimestamp","requesterId","paidAmount","message"],"ignoreList":[],"sourceRoot":""}